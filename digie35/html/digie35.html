<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-png" href="images/digie35-film-strip-96.png" />
	<script type="text/javascript" src="qrcode.js"></script>
	<script type="text/javascript" src="tagify.js"></script>
    <script type="text/javascript" src="tagify.polyfills.min.js"></script>
    <link href="tagify.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="dragsort.js"></script>
    <link href="dragsort.css" rel="stylesheet" type="text/css" />
    <title>Digie35</title>

    <style>
        body, textarea {
            font-family: "Arial";
            font-size: 13px;
            margin: 0px;
        }

        button {
            font-size: 12px;
        }

        .current-action {
            background-color: #4CAF50;
        }

        .pre-action {
            background-color: #f3f2bb;
        }

        .centered-btn {
            text-align: center;
        }

        .vertical-spacer {
            padding-top: 3px;
            padding-bottom: 3px;
        }

        select {
            width: 26ch;
        }

        textarea.description {
            width: 37ch;
            max-width: 42ch;
            resize: vertical;
            min-height: 1.5em;
            box-sizing: border-box;

        }

        input.id {
            width: 24ch;
        }

        .left-sidebar {
            float: left;
            /*width: 42ch;*/
            /*transition: max-width 0.3s ease-in-out; ugly formating during transition*/
            max-width: 42ch;
            margin-top: 10px;
            margin-right: 5px;
        }

        .vertical-toggle {
            width: 10px;
            writing-mode: vertical-rl;
            height: 100%;
            display: flex;
        }

        .horizontal-spacer {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .horizontal-wrap-spacer {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: space-around;
            align-items: center;
        }

        .horizontal-spacer * {
            text-align: center;
        }

        .inline-container {
            position: relative;
        }

        .inline-toggle {
            position: absolute;
            display: inline-block;
            padding: 4px;
            border: 1px solid black;
            background: lightgrey;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            z-index: -1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            border-radius: 8px;
            width: 80vw;
            max-width: 500px;
            /*height: 80vh;*/
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            box-sizing: border-box;
            overflow: hidden;
        }

        .modal .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: lightslategrey;
            color: rgb(247, 236, 236);
        }

        .modal .title {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            flex-grow: 1;
            color: black;
        }

        .modal .close {
            background: none;
            border: none;
            color: black;
            font-size: 24px;
            cursor: pointer;
        }

        .modal .content {
            padding: 20px;
            text-align: left;
            overflow-y: auto;
            max-height: 80vh;
        }

        .modal-active {
            display: flex !important;
            z-index: 1000;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .form-group .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .form-group label {
            width: 30%;
            font-weight: bold;
        }

        .form-group select {
            padding: 3px;
            background-color: white;
            border: 1px solid gray;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .form-group input {
            padding: 3px;
            background-color: white;
            border: 1px solid gray;
            border-radius: 5px;
            font-size: 16px;
        }

        .modal textarea {
            width: 100%;
            resize: vertical;
            min-height: 1.5em;
            box-sizing: border-box;
            height: 20em;
            border: 1px solid gray;
            border-radius: 5px;
        }

        .form-group .hint {
            font-size: 12px;
            color: gray;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px !important;  /* to override form-group label */
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: gray;
        }

        input:focus + .slider {
            box-shadow: 0 0 2px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(20px);
            -ms-transform: translateX(20px);
            transform: translateX(20px);
        }

        .slider.round {
            border-radius: 20px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .switch-container .text {
            margin-left: 10px;
            /*font-size: 16px;*/
        }

        .accordion fieldset {
            border: none;
            padding: 0;
            margin: 0;
            background: none;
            display: block;
        }

        .accordion .header {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            align-items: center;
            font-size: 12px;
            cursor: pointer;
            padding: 2px;
            background: lightgray;
            border: 1px solid black;
        }

        .accordion .header button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-right: 3px;
        }

        .accordion .header .title {
            flex-grow: 1;
            text-align: right;
            padding-right: 1px;
        }

        .accordion .header .subtitle {
            display: inline-block;  /* to accept max.width */
            vertical-align: middle;
            margin-left: 5px;
            max-width: 210px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-style: italic;
            border: 1px solid gray;
            padding-left: 2px;
            padding-right: 2px;
            background: white;
        }

        .accordion .header .subtitle:hover {
            white-space: normal;
            overflow: visible;
            max-width: none;
            position: relative;
            z-index: 10;
        }

        .accordion .header .subtitle:empty {
            display: none;
        }

        .accordion.closed .header .arrow {
            transform: rotate(-90deg);
        }

        .accordion.closed .control-set {
            /*display: none;*/
            padding: 0px 10px;
            max-height: 0px;
            overflow: hidden;
        }

        .accordion .control-set {
            display: block;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding: 8px;
            max-height: 1000px;
        }

        .top-right-toggle {
            top: -2px;
            right: -4px;
        }

        .top-left-toggle {
            top: 2px;
            left: -2px;
        }

        .collapse-toggle {
            background: #FEFEFE;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            user-select: none;
            /*transition: all 0.3s ease-in-out;*/
        }

        .toggle-collapsed {
            transform: rotate(180deg);
        }

        .left-sidebar.collapsed {
            /*max-width: 0px;
            overflow: hidden;*/
            display: none;
        }

        #preview-fieldset legend {
            margin-left: 20px;
        }

        #stream-control {
            max-height: 100px;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            overflow: hidden;
        }

        #stream-control.collapsed {
            max-height: 0px;
        }

        .preview {
            /*margin-left: 42ch;*/
            flex-grow: 1;
            margin-top: 4px;
        }

        #stream-container {
            position: relative;
            display: inline-block;
            overflow: auto;
            width: 100%;
            height: 100%;
        }

        #stream-container img {
            display: block;
            max-width: 100%;
            height: auto;
        }

        #stream-container canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        /*
        .preview img {
        }*/

        .wrapper {
            transform: scale(1);
            transform-origin: left top;
            display: flex;
            height: 100vh;
		}

        .wrapper:after {
            height: 100%;
            content: "";
            display: table;
            clear: both;
        }

        .error-message {
            background-color: #F8D7DA;
            color: #721c24;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .error-message .close {
            position: absolute;
            top: 0;
            right: 5px;
            cursor: pointer;
        }

        .error-message .icon {
            margin-right: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        .error {
             color: #ff0000;
        }

        .warning {
            color: #ff0000;
        }

        .clickable {
            text-decoration: underline;
            cursor: pointer;
        }

        .detail {
            display: none;
        }

        .hidden {
            display: none;
        }

        .invert {
            filter: invert(100%);
        }

        .rotate180 {
            transform: rotate(180deg);
        }

        .rotate90 {
            transform: rotate(90deg) scale(0.55, 0.55);
        }

        .rotate270 {
            transform: rotate(-90deg) scale(0.55, 0.55);
        }

        .flip-rotate0 {
            transform: rotateY(180deg)
        }

        .flip-rotate180 {
            transform: rotateX(180deg)
        }

        .flip-rotate90 {
            transform: rotateY(180deg) rotate(90deg) scale(0.55, 0.55);
        }

        .flip-rotate270 {
            transform: rotateY(180deg) rotate(-90deg) scale(0.55, 0.55);
        }

        .grey-border {
            padding: 5px;
            background-color: #D0D0D0;
        }

        /* indicate that hotkeys won't work when control focused. No indication in modal needed */
        .wrapper input[type="number"]:focus, .wrapper input[type="text"]:focus, .wrapper textarea:focus {
            outline: none !important;
            border: 2px solid #2d282f;
            background-color: #e8fbfd;
        }

        /*
        input[type="range"]:focus {

        } */
        .hotkey-enabled {
            border-color: #2c562c;
        }

        #stream {
            width: 1200px;
            object-fit: cover;
            /*object-position: 95px 0px;*/
        }

        input[type="range"].color-range {
            margin: 2px;
        }

        input[type="range"].color-range::-webkit-slider-thumb {
            outline: solid gray 1px;
            outline-offset: -1;
            border-radius: 50%;
        }

        .color-range input[type="range"]::-moz-range-thumb {
            outline: solid gray 1px;
            outline-offset: -1;
            border-radius: 50%;
        }

        .range-value {
            font-size: 12px;
        }

        /* input range styling */
        #preview-fieldset input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            border: solid gray 1px;
            border-radius: 4px;
            opacity: 0.7;
            margin: 5px;
            background: lightgray;
            /* accent-color: gray;  does not work and javascript is required to manipulate with background linear-gradient */
        }

        #preview-fieldset input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border: 0;
            border-radius: 50%;
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
        }

        #preview-fieldset input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border: 0;
            border-radius: 50%;
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
        }

        input#crop-x-rng::-webkit-slider-thumb {
            background-image: url('images/digie35-crop-width.svg');
        }
        input#crop-x-rng::-moz-range-thumb {
            background-image: url('images/digie35-crop-width.svg');
        }
        input#crop-y-rng::-webkit-slider-thumb {
            background-image: url('images/digie35-crop-height.svg');
        }
        input#crop-y-rng::-moz-range-thumb {
            background-image: url('images/digie35-crop-height.svg');
        }
        input#background-rng::-webkit-slider-thumb {
            background-image: url('images/digie35-crop.svg');
        }
        input#background-rng::-moz-range-thumb {
            background-image: url('images/digie35-crop.svg');
        }

        #preview-fieldset input[type="range"]#background-rng {
            background: linear-gradient(90deg, black, gray, white)
        }

        .notify-update-animate {
            animation: tilt-shaking 0.5s infinite;
            display: inline-block;
        }

        .screen-notification {
            max-width: 100vw;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 200px;
            font-weight: bold;
            text-shadow: 2px 2px 4px black;
            color: orange;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }

        @keyframes tilt-shaking {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        .right-button-column-container {
            display: flex;
            align-items: flex-start;
        }

        .right-button-column-container .tags-container {
            flex: 1;
            min-height: 40px;
        }

        .file-template--counter .icon {
            background-color: orange;
            color: black;
            border-radius: 50%;
            padding: 1px 1px;
            margin-left: 3px;
            font-size: 1.0rem;
            vertical-align: middle;
            cursor: pointer;
        }

        .tagify {
            width: 100%;
        }

        .tagify__input::before {   /* to display placeholder */
            opacity: 1;
            position: static;
        }

        .button-column {
            display: flex;
            flex-direction: column;
            margin-left: 4px;
        }

        .button-column button {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1;
            padding: 0;
            margin-bottom: 4px;
            width: 1.0rem;
            height: 1.0rem;
        }

    </style>
</head>

<body onload="do_onload()">
    <div id="error-box" class="error-message hidden">
        <span class="icon">&#x26a0;</span>
        <span id="error-close" class="close">&times;</span>
        <div id="error-content" class="content"></div>
    </div>
    <div class="wrapper">
        <div class="left-sidebar" id="controls">
            <div class="accordion">
                <div class="header">
                    <button class="modal-open" data-modal_id="connection-settings-modal" title="Click to show server details">&#9881</button>
                    <span class="title">Connection</span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="connection-fieldset">
                    <div class="control-set">
                        <div class="vertical-spacer">
                            <button onclick="connect()">Connect</button>
                            <button onclick="disconnect()">Disconnect</button>
                            <!-- <button id="hotplug-btn" onclick="hotplug()">Hotplug</button>&nbsp; -->
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="accordion">
                <div class="header">
                    <span class="title">Camera<span class="subtitle" id="header-camera-name"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="camera-fieldset">
                    <div class="control-set">
                        <div>
                            <select id="camera-list" name="camera_id" onchange="adjust(); sendCommand('SET_CAMERA', ['camera-list'])">
                                <option value="" selected disabled>select camera...</option>
                            </select>
                            <button onclick="sendCommand('LIST_CAMERAS')" title="Reinitialize gphoto camera list">Refresh&#x21bb;</button>
                        </div>
                        <div id="camera-info" class="vertical-spacer horizontal-spacer">
                            <span id="battery-info" title="Battery charging level notified by camera" >Battery: <span id="battery-level" style="width: 6ch"></span></span>
                            <span><input type="checkbox" id="usb-preview-cb" onchange="adjust_camera_preview(true)" /><label for="usb-preview-cb" accesskey="u" title="Preview using gphoto2 USB"><u>U</u>SB preview<label></span>
                            <span><button class="modal-open" data-modal_id="camera-info-modal" title="Click to show camera detail">Info</button></span>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="accordion">
                <div class="header">
                    <span class="title">Volume<span class="subtitle" id="header-volume-name"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="volume-fieldset">
                    <div class="control-set">
                        <div id="select-volume">
                            <select id="volume-list" onchange="set_volume()">
                                <option value="" selected>select volume...</option>
                            </select>
                            <button onclick="sendCommand('LIST_VOLUMES')" title="Reload volume mounting point directory">Refresh&#x21bb;</button>
                        </div>
                        <div id="volume-info" class="vertical-spacer"></div>
                    </div>
                </fieldset>
            </div>

            <div class="accordion">
                <div class="header">
                    <span class="title">Project<span class="subtitle" id="header-project-name"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="project-fieldset">
                    <div class="control-set">
                        <select id="project-list" onchange="update_project_selection(false);adjust()">
                            <option value="" selected>select project...</option>
                        </select>
                        <button onclick="sendCommand('LIST_PROJECTS')" title="Reload project repository">Refresh&#x21bb;</button>                        
                        <div class="vertical-spacer"><input type="text" id="project_id" class="id" placeholder="enter project id..." maxlength="25" /></div>
                        <div><textarea id="project_descr" class="description" placeholder="enter project description..."></textarea></div>
                        <div>
                            <button id="create-project-btn" onclick="sendCommand('CREATE_PROJECT', ['project_id', 'project_descr']);">Create</button>
                            <button id="update-project-btn" onclick="sendCommand('UPDATE_PROJECT', ['project_id', 'project_descr']);sendCommand('LIST_PROJECTS')">Update</button>
                            <button id="delete-project-btn" onclick="sendCommand('DELETE_PROJECT', ['project_id']);sendCommand('LIST_PROJECTS')">Delete</button>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="accordion">
                <div class="header">
                    <button class="modal-open" data-modal_id="film-settings-modal" title="Click to show film setting">&#9881</button>
                    <span class="title">Film<span class="subtitle" id="header-film-name"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="film-fieldset">
                    <div class="control-set">
                        <select id="film-list" onchange="update_project_selection(true);adjust()">
                            <option value="" selected>select film...</option>
                        </select>
                        <button onclick="sendCommand('GET_PROJECT', ['project_id'])" title="Reload project directory and enumerate films">Refresh&#x21bb;</button>
                        <div class="vertical-spacer">
                            <input type="text" id="film_id" class="id" placeholder="enter film id, e.g. C_001_35" maxlength="25" title="The first digit group is considered as counter and will be incremented inside mask (prefix-counter-suffix). Use enough nulls to reserve place in mask, e.g. BW_001_Agfa, C_002_Kodak, 003, ..." />
                        </div>
                        <div><textarea id="film_descr" class="description" placeholder="enter film description..."></textarea></div>
                        <div class="vertical-spacer horizontal-spacer">
                            <button id="film_id-plus" title="Find next empty film or create new one, KeyP" onclick="create_next_film_id()">Next film</button>
                            <span id="capture-count" title="Number of captured images in film directory"></span>
                        </div>
                        <div class="vertical-spacer">
                            <button id="create-film-btn" onclick="sendCommand('CREATE_FILM', ['project_id', 'film_id', 'film_descr']);">Create</button>
                            <button id="update-film-btn" onclick="sendCommand('UPDATE_FILM', ['project_id', 'film_id', 'film_descr']);sendCommand('GET_PROJECT', ['project_id', 'film_id'])">Update</button>
                            <button id="delete-film-btn" onclick="sendCommand('DELETE_FILM', ['project_id', 'film_id']);sendCommand('GET_PROJECT', ['project_id'])">Delete</button>
                            <button class="modal-open" data-modal_id="capture-info-modal" title="Click to show file list of captured pictures">Files</button>
                        </div>
                        <div id="file-template-options-film" class="centered-btn vertical-spacer horizontal-wrap-spacer">
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="accordion">
                <div class="header">
                    <button class="modal-open" data-modal_id="motion-settings-modal" title="Click to show motion setting">&#9881</button>
                    <span class="title">Motion<span class="subtitle" id="header-motion-name"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="motion-fieldset">
                    <div class="control-set">
                        <div class="centered-btn vertical-spacer">
                            <label><input type="number" id="film-position" disabled="disabled" style="width:9ch" title="Calculated film position" /><input type="number" step="0.01" id="frame-correction" value="0" style="width:7ch" title="Standard frame distance is 38mm. The value will be adjusted by this value when moving film to next frame"/>mm</label>        
                        </div>
                        <div class="centered-btn vertical-spacer">
                            <button id="move-4b-btn" title="ArrowLeft, KeyA">&lt;&lt;&lt;&lt;</button>
                            <button id="move-3b-btn" title="KeyS">&lt;&lt;&lt;</button>
                            <button id="move-3f-btn" title="KeyK">&gt;&gt;&gt;</button>
                            <button id="move-4f-btn" title="ArrowRight, KeyL">&gt;&gt;&gt;&gt;</button>
                        </div>
                        <div class="centered-btn vertical-spacer">
                            <button id="move-2b-btn" title="Shift+ArrowLeft, KeyD">&lt;&lt;</button>
                            <button id="move-1b-btn" title="KeyF">&lt;</button>
                            <button id="stop-btn"    title="Esc, KeyG">STOP</button>
                            <button id="move-1f-btn" title="KeyH">&gt;</button>
                            <button id="move-2f-btn" title="Shift+ArrowRight, KeyJ">&gt;&gt;</button>
                        </div>
                        <div class="centered-btn vertical-spacer">
                            <button id="flatten-1f-btn" title="Ctrl+ArrowUp, KeyC">&uarr;</button>
                            <button id="moveby-1b-btn" title="Ctrl+Shift+ArrowLeft">&lt;~</button>
                            <button id="frame-1b-btn" title="Ctrl+ArrowLeft, Comma">[&nbsp;&lt;&lt;&nbsp;]</button>
                            <button id="frame-1f-btn" title="Ctrl+ArrowRight, Period">[&nbsp;&gt;&gt;&nbsp;]</button>
                            <button id="moveby-1f-btn" title="Ctrl+Shift+ArrowRight">~&gt;</button>
                            <button id="flatten-2f-btn" title="Ctrl+ArrowDown, KeyV">&darr;</button>
                        </div>
                        <div class="centered-btn vertical-spacer">
                            <button id="eject-1b-btn" title="End, KeyQ">&lt; EJECT</button>
                            <button id="insert-btn" title="Insert, KeyI, Backspace">LEAD-IN</button>
                            <button id="eject-1f-btn" title="Home, KeyW">EJECT &gt;</button>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div class="accordion">
                <div class="header">
                    <button class="modal-open" data-modal_id="capture-settings-modal" title="Click to show capture setting">&#9881</button>
                    <span class="title">Capture<span class="subtitle" id="header-capture-filename"></span></span>
                    <span class="arrow">&#9660;</span>
                </div>
                <fieldset id="capture-fieldset">
                    <div class="control-set">
                        <div id="backlight-fieldset" class="centered-btn">
                            <div class="horizontal-spacer">
                                <span><input type="checkbox" id="backlight-cb" value="1" onchange="adjust_backlight()" /><label for="backlight-cb" accesskey="b" title="Switch on/off backlight, KeyB"><u>B</u>acklight</label></span>
                            </div>
                            <div id="backlight-color-ranges" class="vertical-spacer">
                                <!-- order a-w-b-g-r is important -->
                                <div id="backlight-amber-container" class="hidden"><input type="range" id="backlight-amber-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" style="accent-color: rgb(253, 246, 230)" title="Backlight amber LED intensity" /><span id="backlight-amber-value" class="range-value" /></div>
                                <div id="backlight-white-container" class="hidden"><input type="range" id="backlight-white-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" style="accent-color: white" title="Backlight white LED intensity" /><span id="backlight-white-value" class="range-value" /></div>
                                <div id="backlight-red-container" class="hidden"><input type="range" id="backlight-red-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" style="accent-color: red" title="Backlight red LED intensity" /><span id="backlight-red-value" class="range-value" /></div>
                                <div id="backlight-green-container" class="hidden"><input type="range" id="backlight-green-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" style="accent-color: green" title="Backlight green LED intensity" /><span id="backlight-green-value" class="range-value" /></div>
                                <div id="backlight-blue-container" class="hidden"><input type="range" id="backlight-blue-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" style="accent-color: blue" title="Backlight blue LED intensity" /><span id="backlight-blue-value" class="range-value" /></div>
                                <div id="backlight-ir-container" class="hidden"><input type="range" id="backlight-ir-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" title="Backlight infrared LED intensity" /><span id="backlight-ir-value" class="range-value" /></div>
                                <div id="backlight-external-container" class="hidden"><input type="range" id="backlight-external-rng" value="60" min="0" max="255" oninput="adjust_backlight()" class="color-range" title="Backlight manual adapter LED intensity" /><span id="backlight-external-value" class="range-value" /></div>
                            </div>
                        </div>
                        <div class="centered-btn vertical-spacer">
                            <input type="radio" name="capture-mode" id="capture-mode-single-rb" value="single" checked /><label for="capture-mode-single-rb" accesskey="n" title="It will capture one photo and move in case of Auto-move is set">Si<u>n</u>gle</label>
                            <input type="radio" name="capture-mode" id="capture-mode-serial-rb" value="serial" /><label for="capture-mode-serial-rb" accesskey="s" title="It will capture when film frame is ready and is available for motorized adapters only and implies auto move"><u>S</u>erial</label>
                            <input type="radio" name="capture-mode" id="capture-mode-multi-rb" value="multi" /><label for="capture-mode-multi-rb" accesskey="m" title="It will capture specific number of pictures. Auto move settings is essential"><u>M</u>ulti</label>
                        </div>
                        <div id="file-template-options-capture" class="centered-btn vertical-spacer horizontal-wrap-spacer">
                        </div>
                        <div id="file-template-options-capture-multi" class="vertical-spacer hidden">
                            <div class="right-button-column-container">
                                <div class="tags-container">
                                    <input type="text" name="file-template--multi" class="tags-control" placeholder="frame queue..." />
                                </div>
                                <div class="button-column">
                                    <button id="file-template--add" class="tags--addBtn" title="Add sequentially parameters for next film frames which will be automatically popped after capture">+</button>
                                    <button id="file-template--remove" class="tags--removeAllBtn" title="Clear all">&times;</button>
                                </div>
                            </div>
                        </div>
                        <div class="vertical-spacer centered-btn">
                            <button id="shoot-btn" title="Numpad0,X">Shoot!</button>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
        <div id="preview" class="preview inline-container">
            <fieldset id="preview-fieldset">
                <legend>Preview (<span id="preview-source"></span>)</legend>
                <div id="stream-error" class="error-message"><span class="icon">&#x26a0;</span>Stream is not available</div>
                <div id="stream-container" class="inline-container">
                    <div id="stream-control">
                        <input type="checkbox" id="invert-cb" value="invert" onchange="adjust_preview()" /><label for="invert-cb" accesskey="i" title="Invert preview"><u>I</u>nvert</label>
                        <input type="radio" name="rotate" id="rotate0-rb" value="rotate0" onchange="adjust_preview()" checked /><label for="rotate0-rb" accesskey="t" title="Rotate 0&deg;">Ro<u>t</u>ate 0&deg;</label>
                        <input type="radio" name="rotate" id="rotate270-rb" value="rotate270" onchange="adjust_preview()" /><label for="rotate270-rb" accesskey="a" title="Rotate -90&deg;">Rot<u>a</u>te -90&deg;</label>
                        <input type="radio" name="rotate" id="rotate180-rb" value="rotate180" onchange="adjust_preview()" /><label for="rotate180-rb" accesskey="o" title="Rotate 180&deg;">R<u>o</u>tate 180&deg;</label>
                        <input type="radio" name="rotate" id="rotate90-rb" value="rotate90" onchange="adjust_preview()" /><label for="rotate90-rb" accesskey="e" title="Rotate 90&deg;">Rotat<u>e</u> 90&deg;</label>
                        <input type="checkbox" id="flip-cb" value="flip" onchange="adjust_preview()" /><label for="flip-cb" accesskey="f" title="Flip preview"><u>F</u>lip</label>
                        <input type="range" id="crop-x-rng" value="95" min="0" max="500" oninput="adjust_preview()" title="Width clipping" />
                        <input type="range" id="crop-y-rng" value="0" min="0" max="300" oninput="adjust_preview()" title="Height clipping" />
                        <input type="range" id="background-rng" value="200" min="0" max="255" oninput="adjust_preview()" title="Background color" />
                    </div>
                    <div id="stream-container" class="grey-border">
                        <img id="stream" onload="do_imgok();" onerror="do_imgerror();" />
                        <canvas id="canvas"></canvas>
                    </div>
                    <div class="collapse-toggle inline-toggle top-right-toggle" data-container_id="stream-control" title="Click to collapse/reveal stream controls">
                        <span class="arrow">
                            &#9650;
                        </span>
                    </div>
                </div>
            </fieldset>
            <div class="collapse-toggle inline-toggle top-left-toggle" data-container_id="controls" title="Click to collapse/reveal control sidebar">
                <span class="arrow">
                    &#9664; <!-- left arrow -->
                </span>
            </div>
        </div>
    </div>
    <div class="modal-container">
        <div id="connection-settings-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        Connection settings
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="verbose-list" accesskey="v"><u>V</u>erbosity</label>
                            <select id="verbose-list" name="level" style="width: 12ch" onchange="sendCommand('VERBOSE', ['verbose-list'])">
                                <option value="0">Critical</option>
                                <option value="1">Error</option>
                                <option value="2">Warning</option>
                                <option value="3">Info</option>
                                <option value="4">Debug</option>
                                <option value="5">Debug 1</option>
                                <option value="6">Debug 2</option>
                            </select>
                        </div>
                        <small class="hint">Server side logging verbosity. It is global service settings. More verbose levels may flood the control socket</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="logger-cb" accesskey="l"><u>L</u>ogger</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="logger-cb" onchange="adjust_logger()" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Redirect looging output to browser console.
                            <ul>
                                <li>
                                    <b>Chrome</b>, <b>Edge</b>, <b>Firefox</b>: Press <code>F12</code> or <code>Ctrl+Shift+I</code> (Windows/Linux), <code>Cmd+Option+I</code> (MAC)
                                </li>
                                <li>
                                    <b>Safari</b>: enable <i>Developer mode</i> <i>Preferences > Advanced > Show Develop menu</i> then press <code>Cmd+Option+C</code>
                                </li>
                                <li>
                                    <b>Alternative method</b>:Right-click anywhere in the page, select <i>Inspect</i>, then go to the <i>Console tab</i>
                                </li>
                            </ul>
                        </small>
                    </div>

                    <div id="remote-control">
                        <div class="form-group vertical-spacer">
                            <div class="input-row">
                                <label for="logger-cb">URL</label>
                                <input id="rc-url" style="width: 20ch" readonly />
                            </div>
                            <small class="hint">URL to connect Digie35 server from local LAN. You can also connect via QR code</small>
                        </div>
                        <div id="rc-qrcode"></div>
                    </div>
                    <div class="vertical-spacer">
                        <textarea id="server-info" readonly placeholder="click Connect button to connect..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="camera-info-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        Camera info
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">
                    <div class="vertical-spacer">
                        <textarea id="camera-abilities" readonly placeholder="list of camera abilities when camera is connected..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="capture-info-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        List of image files
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">
                    <div class="vertical-spacer">
                        <textarea id="capture-list" readonly placeholder="list of files..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="film-settings-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        Film settings
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="autoinc-cb" accesskey="a"><u>A</u>uto increment</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="autoinc-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Auto increment film id when lead-in film. Switch off in case of wrong perforation or a few frame strips which were cut from one film</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="file-template-list" accesskey="t">File <u>t</u>emplate</label>
                            <select id="file-template-list" name="template_id" style="width:20ch" onchange="sendCommand('GET_TEMPLATE', [this.id])">
                                <option value="" selected>--default--</option>
                            </select>
                        </div>
                        <small class="hint">Define pattern which is used for image file name. Also a side effect as LED or preset setting is supported. Recipies are defined at server side</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="notify-film-id-cb" accesskey="n"><u>N</u>otify film</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="notify-film-id-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Notify visually user that next film id has been created. If <i>auto-Inc</i> option is enabled then id is created automatically when next film is detected in motorized adapter but it might not be reliable in case of damaged perforation or so.</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="notify-image-filename-cb" accesskey="i">Notify <u>i</u>mage filename</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="notify-image-filename-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Notify visually image file name when being downloaded from camera.</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="motion-settings-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        Motion settings
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="reverse-cb" accesskey="r" ><u>R</u>everse</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="reverse-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Reverse sense of film movement versus button control direction</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="autolead-cb" accesskey="l" >Auto <u>l</u>ead</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="autolead-cb" value="1" checked />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Autolead-in film into adapter when film is detected by front sensor</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="sticky-cb" accesskey="s" ><u>S</u>ticky</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="sticky-cb" value="1" checked />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Sticky movement buttons, i.e.movement in progress till button is being pressed (key, mouse, touch). Otherwise stop movement by <i>Stop</i> button</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="automove-cb" accesskey="m">Auto <u>m</u>ove</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="automove-cb" value="1" checked />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Start film moving when picture captured</small>
                    </div>

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="autocorrection-cb" accesskey="c" >Auto <u>c</u>orrection</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="autocorrection-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Set <i>Frame correction</i> from consequent capture positions</small>
                    </div>

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="flattening-cb" accesskey="f" ><u>F</u>lattening press</label>
                            <div class="switch-container">
                                <label class="switch">
                                    <input type="checkbox" id="flattening-cb" value="1" />
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <small class="hint">Move frame down and press against film plane to flatten surface</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="capture-settings-modal" class="modal-overlay">
            <div class="modal">
                <div class="header">
                    <span class="title">
                        Capture settings
                    </span>
                    <button class="close">&times;</button>
                </div>
                <div class="content">

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="backlight-color-list" accesskey="l"><u>L</u>ED colors</label>
                            <select id="backlight-color-list" style="width:11ch" onchange="adjust_backlight(true)">
                                <option value="white" selected>White</option>
                                <option value="red+green+blue">RGB</option>
                                <option value="white+red+green+blue">RGBW</option>
                                <option value="amber+white+red+green+blue">RGBAW</option>
                                <option value="ir">IR</option>
                                <option value="external">Manual</option>
                            </select>
                        </div>
                        <small class="hint">Set backlight LED set to illuminate film. Each color intensity can be adjusted individually. In case of color negative orange mask can be masked off.</small>
                    </div>

                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="capture-multi" accesskey="m"><u>M</u>ulti count</label>
                            <input type="number" step="1" min="1" max="99" id="capture-multi" value="1" style="width:5ch" />
                        </div>
                        <small class="hint">Multiple capture with or without auto move</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="serial-shoot-delay-rng" accesskey="c"><u>C</u>apture delay</label>
                            <span id="serial-shoot-delay">
                                <input type="range" id="serial-shoot-delay-rng" value="1" min="0" max="10" oninput="adjust_delay_value(this)" />
                                <span id="serial-shoot-delay-value" class="range-value"></span>
                            </span>
                        </div>
                        <small class="hint">Delay in before next serial capture. It gets some time to interrupt operation via STOP even lagging preview</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="shoot-mode-list" accesskey="s"><u>S</u>hooting mode</label>
                            <select id="shoot-mode-list" style="width:20ch">
                                <option value="capture|download" selected>Download</option>
                                <option value="capture|download+sdcard">Download+SD card</option>
                                <option value="capture|sdcard">SD card</option>
                                <option value="trigger|f-s">Wire trigger (F-S)</option>
                                <option value="trigger|f-fs">Wire trigger (F-F+S)</option>
                            </select>
                        </div>
                        <small class="hint">Download or leave image on camera SD card, wire remote control (focus-shutter or focus-focus+shutter)</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="trigger-delay-rng" accesskey="t"><u>T</u>rigger delay</label>
                            <span id="trigger-delay">
                                <input type="range" id="trigger-delay-rng" value="1" min="1" max="20" oninput="adjust_delay_value(this)" />
                                <span id="trigger-delay-value" class="range-value"></span>
                            </span>
                        </div>
                        <small class="hint">Delay after shoot is triggered by wire to delay any action till capture is finished</small>
                    </div>
                    <div class="form-group vertical-spacer">
                        <div class="input-row">
                            <label for="preset-list" accesskey="p"><u>P</u>reset</label>
                            <select id="preset-list" style="width:20ch">
                                <option value="" selected>--no XMP file--</option>
                            </select>
                        </div>
                        <small class="hint">Create XMP file related to image, e.g. preview orientation is referenced. Alternatively info can be merged to a preset so e.g. negative can be automatically inverted when browsing gallery</small>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="screen-notification" class="screen-notification"></div>
</body>

<script>
    window.frame_width_in_mm = 36+2;
    window.move_by_in_mm = 0.4;  // TODO: how is calculated movement when 3 / 0.4 gives 1.2 ?
    window.move_by_speed = 3;
    window.frame_speed = 4;

    function adjust() {
        var connected = document.getElementById("server-info").value != "";
        var volume = window.current_volume;
        var camera_list = document.getElementById("camera-list");
        var project_list = document.getElementById("project-list");
        var film_list = document.getElementById("film-list");
        var usb_preview_checkbox = document.getElementById("usb-preview-cb");

        if (camera_list.selectedIndex == 0) {
            update_battery();
        }
        var abilities = (camera_list.selectedIndex > 0) && (typeof window.current_camera != "undefined");
        var elem = document.getElementById("header-camera-name");
        if (abilities) {
            elem.textContent = window.current_camera.model;
        } else {
            elem.textContent = "";
        }
        var usbpreview = connected && abilities && usb_preview_checkbox.checked && window.current_camera.capture_preview;
        if (usbpreview != window.current_usbpreview) {
            document.getElementById("stream").src = "http://"+window._hostname+ ":" + (usbpreview ? "8408" : "8409") + "/stream";
            document.getElementById("preview-source").innerHTML = usbpreview ? "USB" : "HDMI";
            if (connected) {
            }
            window.current_usbpreview = usbpreview;
        }

        document.getElementById("camera-fieldset").disabled = !connected;
        document.getElementById("camera-info").disabled = !abilities;
        usb_preview_checkbox.disabled = !abilities || !window.current_camera.capture_preview;
        if (!abilities) {
            document.getElementById("camera-abilities").value = "";
        }

        if (window.last_project_list_idx !== project_list.selectedIndex) {
            window.last_project_list_idx = project_list.selectedIndex;
            window.last_film_list_idx = null;
            var project_id = document.getElementById("project_id");
            project_id.value = project_list.value;
            set_visible(project_id, project_list.value == "");
            project_id.readOnly = project_list.value != "";
            document.getElementById("header-project-name").textContent = project_id.value;

            var project_description = document.getElementById("project_descr");
            var fl = []
            if (project_list.selectedIndex > 0) {
                var custom = project_list.options[project_list.selectedIndex]._custom_data;
                project_description.value = custom["descr"];
                if (typeof custom["film_list"] != "undefined") {
                    fl = custom["film_list"];
                }
            } else {
                project_description.value = "";
            }
            update_select_options("film-list", fl, "id", "id", (typeof window.current_project_selection[window.current_volume] != "undefined") ? window.current_project_selection[window.current_volume]["film_ids"][project_list.value] : "");
        }

        document.getElementById("volume-fieldset").disabled = !connected;
        document.getElementById("project-fieldset").disabled = !connected || !volume;
        document.getElementById("create-project-btn").disabled = project_list.value != "";
        document.getElementById("update-project-btn").disabled = !document.getElementById("create-project-btn").disabled;
        document.getElementById("delete-project-btn").disabled = document.getElementById("update-project-btn").disabled || (film_list.length > 1);

        document.getElementById("film-fieldset").disabled = !connected || !volume || (project_list.value == "");

        if (window.last_film_list_idx !== film_list.selectedIndex) {
            window.last_film_list_idx = film_list.selectedIndex;

            var film_id = document.getElementById("film_id");
            film_id.value = film_list.value;
            set_visible(film_id, film_id.value == "", "inline-block");
            film_id.readOnly = film_id.value != "";
            document.getElementById("header-film-name").textContent = film_id.value;
            document.getElementById("film_descr").value =
                film_list.selectedIndex > 0 ? film_list.options[film_list.selectedIndex]._custom_data["descr"] : "";
            var vals = get_file_template_values();
            if (Object.keys(vals.values).length !== 0) {  // avoid test when uninitialized
                sendCommand("VALIDATE_TEMPLATE", ['project_id', 'film_id'], vals);
            }
        }
        var cnt = 0;
        var capture_list = document.getElementById("capture-list");

        function shorten_bytes(n) {
            const k = n > 0 ? Math.floor((Math.log2(n)/10)) : 0;
            const rank = (k > 0 ? 'kMGT'[k - 1] : '') + 'B';
            const count = Math.floor(n / Math.pow(1024, k));
            return count + rank;
        }

        if (film_list.selectedIndex > 0) {
            var custom = film_list.options[film_list.selectedIndex]._custom_data;
            cnt = custom["captured"].length;
            var f = [];
            for (const i in custom["captured"]) {
                var sz = custom["captured"][i]["size"] ? shorten_bytes(custom["captured"][i]["size"]) : "link";
                f.push(custom["captured"][i]["name"] +" ("+ sz + ")");
            }
            capture_list.value = f.join("\n");
        } else {
            capture_list.value = "";
        }
        document.getElementById("capture-count").innerHTML = "Image count: " + cnt;

        document.getElementById("create-film-btn").disabled = (project_list.value == "") || (film_list.value != "");
        document.getElementById("update-film-btn").disabled = (project_list.value == "") || (film_list.value == "");
        document.getElementById("delete-film-btn").disabled = document.getElementById("update-film-btn").disabled || (cnt >0);

        document.getElementById("motion-fieldset").disabled = !connected || typeof window.capabilities == "undefined" || !window.capabilities.motorized;
        document.getElementById("capture-fieldset").disabled = !connected;
        elem = document.getElementById("shoot-mode-list");
        document.getElementById("shoot-btn").disabled = (camera_list.value == "") || (project_list.value == "") || (film_list.value == "") || !volume || !abilities ||
            elem.selectedIndex < 0 || elem.options[elem.selectedIndex].disabled;

    }

    function adjust_adapter(data) {
        if (typeof window.last_adapter_data != "undefined") {
            var update = (window.last_adapter_data.movement != data.movement) ||
                (window.last_adapter_data.film_inserted != data.film_inserted) ||
                (window.last_adapter_data.frame_ready != data.frame_ready) ||
                (window.last_adapter_data.action != data.action) ||
                (window.last_adapter_data.capturing != data.capturing);
        } else {
            var update = true;
        }
        window.last_adapter_data = data;
        if (update) {
            function adjust_class(prefix, dir, value, class_name = "current-action") {
                var elem = get_adapter_button(prefix, dir);
                if (value != elem.classList.contains(class_name)) {
                    elem.classList.toggle(class_name);
                }
            }
            adjust_class("insert", "", data.action=="LEAD_IN");
            adjust_class("insert", "", data.film_inserted, "pre-action");
            adjust_class("stop", "", data.movement==0);
            var arr = window.adapter_buttons['move'].idx;
            for (const i in arr) {
                adjust_class("move", arr[i], (data.action=="MOVE") && (data.movement == reverse(arr[i])));
            }
            arr = window.adapter_buttons['moveby'].idx;
            for (const i in arr) {
                adjust_class("moveby", arr[i], (data.action=="MOVE_BY") && ((data.movement > 0) == (reverse(arr[i]) > 0)) && (Math.abs(data.movement) == window.move_by_speed));
            }
            arr = window.adapter_buttons['frame'].idx;
            for (const i in arr) {
                adjust_class("frame", arr[i], (data.action=="MOVE_BY") && ((data.movement > 0) == (reverse(arr[i]) > 0)) && (Math.abs(data.movement) == window.frame_speed));
            }
            window.adapter_buttons['eject'].idx;
            for (const i in arr) {
                adjust_class("eject", arr[i], (data.action=="EJECT") && ((data.movement > 0) == (reverse(arr[i]) > 0)));
            }
            var action_elem = document.getElementById("motion-fieldset").querySelector(".current-action");
            document.getElementById("header-motion-name").textContent = action_elem ? action_elem.textContent : "";
            if (typeof data.capturing != "undefined") {
                adjust_class("shoot", "", data.capturing);
            }
            adjust_class("shoot", "", data.frame_ready, "pre-action");
        }
    }

    function adjust_capabilities(send_backlight_cmd) {
        var elem = document.getElementById("motion-fieldset");
        set_visible(elem, window.capabilities.motorized);
        elem.disabled = !window.capabilities.motorized;
        elem = document.getElementById("backlight-fieldset");
        set_visible(elem, window.capabilities.backlight_control);
        elem.disabled = !window.capabilities.backlight_control;
        // TODO: setup backlight stuff, white,RGB,IR,preview...
        //elem = document.getElementById("preview-backlight-fieldset");
        //elem.style.display = window.capabilities.preview_backlight_control ? "block" : "none";
        //elem = document.getElementById("hotplug-btn");
        //elem.disabled = !window.capabilities.hot_plug;

        elem = document.getElementById("backlight-color-list");
        items = elem.options;
        var change_value = false;
        var enabled_value = "";
        for (var i = 0; i < items.length; i++) {
            var opt = items[i];
            if (opt.value == "white") {
                opt.disabled = !window.capabilities.white_backlight;
            } else if (opt.value == "ir") {
                opt.disabled = !window.capabilities.ir_backlight;
            } else if (opt.value == "external") {
                opt.disabled = !window.capabilities.preview_backlight;
            } else if (opt.value == "amber+white+red+green+blue") {
                opt.disabled = !window.capabilities.rgbaw_backlight;
            } else if (opt.value == "white+red+green+blue") {
                opt.disabled = !window.capabilities.rgb_backlight || !window.capabilities.white_backlight;
            } else if (opt.value == "red+green+blue") {
                opt.disabled = !window.capabilities.rgb_backlight || window.capabilities.white_backlight;
            } else {
                opt.disabled = !window.capabilities.rgb_backlight;
            }
            if (enabled_value == "" && !opt.disabled) {
                enabled_value = opt.value;
            }
            if (opt.value == elem.value && opt.disabled) {
                change_value = true;
            }
        }
        if (change_value) {
            elem.value = enabled_value;
        }
        adjust_backlight(true, send_backlight_cmd);

        elem = document.getElementById("capture-mode-serial-rb");
        elem.disabled = !window.capabilities.motorized;
        if (elem.disabled && elem.checked) {
            elem.checked = false;
            document.getElementById("capture-mode-single-rb").checked = true;
        }

        items = document.getElementById("shoot-mode-list").options;
        var abilities = (document.getElementById("camera-list").selectedIndex > 0) && (typeof window.current_camera != "undefined");
        // do not adjust value as almost always is required capture which requires camera connection
        items[0].disabled = !abilities || (!window.current_camera.capture_image && !window.current_camera.trigger_capture);
        items[1].disabled = items[0].disabled || !window.current_camera.sdcard_capture;
        items[2].disabled = items[1].disabled;
        items[3].disabled = !window.capabilities.camera_remote_control;
        items[4].disabled = items[3].disabled;
        [1, 2].forEach(idx => {
            var elem = get_adapter_button("flatten", idx);
            set_visible(elem, window.capabilities.flattening, "");
            elem.disabled = !window.capabilities.flattening;
        });
    }

    function adjust_camera_preview(force) {
        var idx = document.getElementById("camera-list").selectedIndex;
        var usb_preview_checkbox = document.getElementById("usb-preview-cb");
        var usbpreview = (idx > 0) && usb_preview_checkbox.checked;
        if (force) {
            window.save_usb_preview = usb_preview_checkbox.checked;
        } else {
            if (idx > 0 && (typeof window.current_camera != "undefined") && window.current_camera.capture_preview) {
                // revert last state if possible
                usbpreview = window.save_usb_preview;
            }
        }
        if (usbpreview) {
            sendCommand("START_PREVIEW", ["camera-list"]);
        } else {
            sendCommand("STOP_PREVIEW", ["camera-list"]);
        }
    }

    function adjust_camera_list(camera_id) {
        // camera_id contains usbid which is increasing, so do some heuristic
        if (typeof camera_id == "undefined" || camera_id == null) {
            return;
        }
        var elem = document.getElementById("camera-list");
        if (elem.selectedIndex == 0) {
            var id_name = camera_id.split('|');
            if (id_name.length > 1) {
                var items = elem.options;
                for (var i = 1; i < items.length; i++) {
                    var opt = items[i];
                    if (opt.value.split("|")[1] == id_name[1]) {
                        elem.selectedIndex = i;
                        break;
                    }
                }
            }
        }
    }

    function set_volume() {
        var volume = document.getElementById("volume-list").value;
        if (volume == "") {
            window.current_volume = ""
        } else {
            sendCommand2("SET_VOLUME", {"volume": volume})
        }
        update_select_options("project-list", [], "name", "name");
        update_volume_info(false);
        adjust();
    }

    function format_volume_info(volume, verbose) {
        var a = [];
        if (volume.partlabel || volume.name) {
            a.push(volume.partlabel ? volume.partlabel : volume.name);
        }
        a.push(volume.size);
        if (verbose) {
            a.push(" used: "+volume["use%"]);
        }
        return a.join("; ");
    }

    function update_volume_info(volume) {
        var elem = document.getElementById("volume-info");
        var elem2 = document.getElementById("header-volume-name");
        if (volume !== false) {
            elem.innerHTML = format_volume_info(volume, true);
            var low_space = Number(volume["use%"].slice(0, -1)) > 95;
            if (low_space != elem.classList.contains("warning")) {
                elem.classList.toggle("warning");
            }
            elem2.textContent = format_volume_info(volume, false);
        } else {
            elem.innerHTML = "";
            elem2.textContent = "";
        }
    }

    function update_battery(level) {
        var elem = document.getElementById("battery-level");
        var low_battery = false;
        if (typeof level == "undefined" || level == null) {
            elem.innerHTML = "N/A";
        } else {
            elem.innerHTML = level;
            var n;
            if (level.charAt(level.length-1) == "%") {
                n = Number(level.slice(0, -1));
            } else {
                n = Number(level);
            }
            low_battery = n < 10;
        }
        if (low_battery != elem.classList.contains("warning")) {
            elem.classList.toggle("warning");
        }
    }

    function update_select_options(id, items, id_field, name_field, selected) {
        var list = document.getElementById(id);
        if (typeof selected != "undefined") {
            var sel = selected;
        } else {
            var sel = list.value;
            if (typeof window.pending_settings[id] != "undefined") {
                sel = window.pending_settings[id];
                delete window.pending_settings[id];
            }
        }
        while (list.length > 1) {
            list.remove(list.length-1);
        }
        var sel2 = "";
        items.forEach((item)=> {
            var opt = new Option(item[name_field], item[id_field]);
            opt._custom_data = item;
            list.add(opt);
            if (sel == item[id_field]) {
                sel2 = sel;
            }
        })
        list.value = sel2;
    }

    function update_status_info(msg, clear = false) {
        var content = document.getElementById("error-content");
        if (clear) {
            content.innerHTML = "";
        }
        if (msg != "") {
            var found = false;
            for (let child of content.children) {
                if (child.textContent === msg) {
                    content.appendChild(child);
                    found = true;
                }
            }
            if (!found) {
                const line = document.createElement("div");
                line.textContent = msg;
                content.appendChild(line);
            }
        }
        var elem = document.getElementById("error-box");
        if (content.innerHTML == "") {
            elem.classList.add("hidden");
        } else {
            elem.classList.remove("hidden");
        }
	}

    function parse_id_as_int(val) {
        var idx = val.search(new RegExp(/[0-9]+/));
        if (idx >= 0) {
            var res = {};
            res.prefix = val.substring(0, idx);
            var val = val.slice(idx);
            idx = val.search(new RegExp(/[^0-9]/));
            if (idx >= 0) {
                res.suffix = val.slice(idx);
				val = val.slice(0, idx);
            } else {
                res.suffix = "";
            }
            res.num = Number(val);
            res.len = val.length;
        } else {
            res = {"prefix": val, "len": 0, "suffix": ""};
        }
		return res;
    }

    function notify_update(elem) {
        var css_name = "notify-update-animate";
        if (!elem.classList.contains(css_name)) {
            elem.classList.toggle(css_name);
        }
        setTimeout(function() {
            elem.classList.remove(css_name);
        }, 300 );
    }

    function screen_notification(text) {
        let notification = document.getElementById("screen-notification");
        // change font size to fit, simple algorithm
        notification.style.fontSize = (text.length > 10) ? "50px" : "";
        notification.textContent = text;
        notification.style.opacity = "1";
        setTimeout(() => {
            notification.style.opacity = "0";
        }, 2000);
    }

    function create_next_film_id() {
        var list = document.getElementById("film-list");
        if (list.selectedIndex > 0) {
            var it = parse_id_as_int(list.options[list.selectedIndex].text);
            if (it.len == 0) {
                it = parse_id_as_int("0");
            }
        } else {
            var it = parse_id_as_int("0");
        }
        it.num++;
		var items = [];
        for (var i = 1; i < list.options.length; i++) {
            var x = parse_id_as_int(list.options[i].text);
            if (x.len > 0 && x.num >= it.num) {
                x.idx = i;
                items.push(x);
            }
        }
        items.sort((a, b) => a.num - b.num);  // sort by num ascending
        for (var i = 0; i < items.length; i++) {
		    if (items[i].num > it.num) {
                // free slot found
                break;
            } else if (items[i].num == it.num) {
                if (list.options[items[i].idx]._custom_data.captured.length == 0) {
                    list.selectedIndex = items[i].idx;
                    update_project_selection(true);
                    adjust();
                    return;
                }
                it.num++;
            }
        }
        var s = it.num.toString();
        while (s.length < it.len) {
            s = "0"+s;
        }
        s = it.prefix + s + it.suffix;
        list.selectedIndex = 0;
        var elem = document.getElementById("film_id");
        elem.value = s;
        notify_update(elem);
        if (document.getElementById("notify-film-id-cb").checked) {
            screen_notification(s);
        }
        document.getElementById("film_descr").value = "";
        document.getElementById("create-film-btn").onclick();
    }

    function check_multicapture() {
        if (typeof window.automove_in_progress != "undefined") {
            if (!window.stop_multicapture) {
                if (window.automove_in_progress == false && window.download_in_progress == false) {
                    var capture_mode = get_radio_button_value("capture-mode");
                    if (capture_mode == "multi") {
                        var cnt_elem = document.getElementById("capture-multi");
                        var cnt = Number(+cnt_elem.value || 1);
                    } else if (capture_mode == "serial") {
                        var cnt = 999;
                    } else {
                        var cnt = 1;
                    }
                    if (cnt > 1) {
                        // delay range is 0..500ms
                        var val = Number(document.getElementById("serial-shoot-delay-rng").value) * 500;
                        setTimeout(function() {
                            if (!window.stop_multicapture) {
                                if (capture_mode == "multi") {
                                    cnt_elem.value = (cnt - 1).toString();
                                }
                                window.adapter_buttons.shoot.action(undefined);
                                delete window.automove_in_progress;
                            }
                        }, val);
                    } else {
                        delete window.automove_in_progress;
                    }
                }
            } else {
                delete window.automove_in_progress;
            }
        }
    }

    function picture_taken(payload) {

        if (window.capabilities.motorized) {
            if (typeof window.last_capture_position != "undefined" && document.getElementById("autocorrection-cb").checked) {
                var x = Math.abs(window.last_capture_position - payload.film_position);
                x -= window.frame_width_in_mm;
                x = x.toFixed(2);
                if (Math.abs(x) < 10) {
                    document.getElementById("frame-correction").value = x.toString();
                }
            }
            window.last_capture_position = payload.film_position;
            if (!window.stop_multicapture) {
                if (document.getElementById("automove-cb").checked || get_radio_button_value("capture-mode") == "serial") {
                    window.automove_in_progress = true;
                    window.adapter_buttons.frame.action(1);
                    window.stop_multicapture = false;
                } else {
                    window.automove_in_progress = false;
                }
            }
        }
    }

    function file_transfer_finished(payload) {
        if (window.multi_tags.has_multi) {
            if (window.multi_tags.value.length > 0) {
                set_file_template_values(JSON.parse(window.multi_tags.value[0].value));
                const tag = window.multi_tags.getTagElms()[0];
                window.multi_tags.removeTag(tag);
            }
        }
        // we do not need wait for response as counters are finally evaluated at server side
        sendCommand('VALIDATE_TEMPLATE', ['project_id', 'film_id'], get_file_template_values());
        sendCommand('GET_PROJECT', ['project_id', 'film_id']);
        if (typeof payload.error != "undefined") {
            window.stop_multicapture = true;
            update_status_info(payload.error);
        }
        if (!window.capabilities.motorized) {
            window.automove_in_progress = false;
        }
        if (document.getElementById("notify-image-filename-cb").checked) {
            screen_notification(payload.file_path.replace(/^.*[\\/]/, ''));
        }
    }

    function connect() {
        if (typeof window.control_socket == "undefined") {
            window.control_socket = new WebSocket('ws://'+window._hostname+':8400');
            window.control_socket.onopen = function(e) {
                console.log("[open] Connection established");
                window.control_socket.send("HELLO");
            };
            window.control_socket.onmessage = function(event) {
                console.log(`[message] Data received from server: ${event.data}`);
                if (event.data[0] == "{") {
                    try {
                        var data = JSON.parse(event.data);
                    } catch(err) {
                        update_status_info(err);
                    }
                    if (typeof data.payload != "undefined") {
                        if (typeof data.payload.film_position != "undefined") {
                            var x = data.payload.film_position;
                            x = x.toFixed(2);
                            document.getElementById("film-position").value = x.toString();
                        }
                        if (typeof data.payload.verbosity != "undefined") {
                            document.getElementById("verbose-list").value = data.payload.verbosity;
                        }
                        if (data.cmd == "ADAPTER" || data.cmd == "GET") {
                            if (data.cmd == "ADAPTER") {
                                if (typeof data.payload.capabilities != "undefined") {
                                    // hotplug
                                    window.steps_per_mm = data.payload.steps_per_mm;
                                    window.capabilities = data.payload.capabilities;
                                    adjust_capabilities(false)
                                }
                                adjust_adapter(data.payload);
                                if (typeof window.capabilities != "undefined" && window.capabilities.motorized) {
                                    if (document.getElementById("autolead-cb").checked && data.payload.film_inserted) {
                                        window.adapter_buttons.insert.action(undefined);
                                    }
                                    if ((data.payload.movement == 0) && (typeof window.automove_in_progress != "undefined")) {
                                        if (data.payload.frame_ready) {
                                            window.automove_in_progress = false;
                                            check_multicapture();
                                        } else {
                                            delete window.automove_in_progress;
                                        }
                                    }
                                }
                            }
                            document.getElementById("backlight-cb").checked = data.payload.backlight.color != "";
                            if (data.payload.backlight.color != "") {
                                var color_list = document.getElementById("backlight-color-list");
                                if (Array.from(color_list.options).filter(
                                    opt => (opt.value == data.payload.backlight.color))
                                .length > 0) {
                                    color_list.value = data.payload.backlight.color;
                                    var colors = data.payload.backlight.color.split("+");
                                    var intensity = data.payload.backlight.intensity;
                                    for (var i = colors.length-1; i >= 0; i--) {
                                        document.getElementById("backlight-"+colors[i]+"-rng").value = intensity % 256;
                                        intensity = Math.trunc(intensity / 256);  // bitwise operations limited to 32-bit
                                    }
                                    adjust_backlight(true, false);
                                }
                            }
                        } else if (data.cmd == "CAMERA") {
                            document.getElementById("usb-preview-cb").checked = data.payload.usbpreview;
                            adjust_adapter(data.payload)
                        } else {
                            if (typeof data.payload.volume_list != "undefined") {
                                var vl = [];
                                var act = false;
                                var act_id = "";
                                data.payload.volume_list.forEach((vol)=>{
                                    vl.push({"id": vol.name, "name": format_volume_info(vol, false)});
                                    if (vol.active) {
                                        act = vol;
                                        act_id = vol.name;
                                    }
                                });
                                update_select_options("volume-list", vl, "id", "name");
                                var elem = document.getElementById("volume-list");
                                if (elem.value != act_id) {
                                    elem.value = act_id;
                                }
                                if (act_id != window.current_volume) {
                                    update_select_options("project-list", [], "name", "name");
                                    window.current_volume = act_id;
                                    update_volume_info(act);
                                    if (act !== false) {
                                        sendCommand("LIST_PROJECTS");
                                    }
                                }
                            }

                            if (typeof data.payload.camera_list != "undefined") {
                                var elem = document.getElementById("camera-list");
                                var current_camera_id = elem.value;
                                update_select_options("camera-list", data.payload.camera_list, "id", "name");
                                data.payload.camera_list.forEach((item)=> {
                                    if (item.current) {
                                        update_battery(item.battery);
                                    }
                                })
                                adjust_camera_list(current_camera_id);
                                if (elem.selectedIndex > 0 /*typeof pend != typeof window.pending_settings["camera-list"]*/ ) {
                                    sendCommand("SET_CAMERA", ["camera-list"]);
                                }
                            }
                            if (typeof data.payload.project_list != "undefined") {
                                update_select_options("project-list", data.payload.project_list, "id", "id", (typeof window.current_project_selection[window.current_volume] != "undefined") ? window.current_project_selection[window.current_volume]["project_id"]: "");
                                update_project_selection(false);
                            }
                            if (typeof data.payload.volume != "undefined") {
                                update_volume_info(data.payload.volume);
                            }
                            if (typeof data.payload.preset_list != "undefined") {
                                var list = []
                                data.payload.preset_list.forEach((item) => {
                                    list.push({"id": item});
                                });
                                update_select_options("preset-list", list, "id", "id");
                            }
                            if (typeof data.payload.file_template_list != "undefined") {
                                var list = []
                                for (const [key, value] of Object.entries(data.payload.file_template_list)) {
                                    list.push({"id": key, "name": value});
                                }
                                update_select_options("file-template-list", list, "id", "name");
                            }
                            if (data.cmd == "SET_CAMERA") {
                                document.getElementById("camera-list").value = data.payload.id;
                                window.current_camera = data.payload;
                                document.getElementById("camera-abilities").value = JSON.stringify(data.payload, null, 2);
                                update_battery(data.payload.battery);
                                adjust_capabilities(false);
                                adjust_camera_preview(false)
                            } else if (data.cmd == "GET_PROJECT") {
                                var project_list = document.getElementById("project-list");
                                var film_list = document.getElementById("film-list");
                                if ((project_list.value == data.payload.id) && (project_list.selectedIndex > 0)) {
                                    if (data.payload.film) {
                                        for (var i = 0; i < project_list.options[project_list.selectedIndex]._custom_data.film_list.length; i++) {
                                            if (project_list.options[project_list.selectedIndex]._custom_data.film_list[i].id == data.payload.film.id) {
                                                project_list.options[project_list.selectedIndex]._custom_data.film_list[i] = data.payload.film;
                                                break;
                                            }
                                        }
                                    } else if (data.payload.film_list) {
                                        project_list.options[project_list.selectedIndex]._custom_data.film_list = data.payload.film_list;
                                    }
                                    window.last_project_list_idx = null;
                                }
                            } else if (data.cmd == "CAPTURE") {
                                picture_taken(data.payload);
                                window.download_in_progress = true;
                                update_battery(data.payload.battery);

                            } else if (data.cmd == "DOWNLOAD") {
                                window.download_in_progress = false;
                                file_transfer_finished(data.payload);
                                check_multicapture();
                            } else if (data.cmd == "CREATE_FILM") {
                                // add new film into select box as placeholder
                                var elem = document.getElementById("film-list");
                                var opt = new Option(data.payload.id, data.payload.id);
                                elem.add(opt);
                                elem.value = data.payload.id;
                                update_project_selection(true);
                                var project_list = document.getElementById("project-list");
                                project_list.options[project_list.selectedIndex]._custom_data.film_list.push(data.payload);
                                sendCommand('GET_PROJECT', ['project_id']);
                            } else if (data.cmd == "CREATE_PROJECT") {
                                // add new project into select box as placeholder
                                var elem = document.getElementById("project-list");
                                var opt = new Option(data.payload.id, data.payload.id);
                                elem.add(opt);
                                elem.value = data.payload.id;
                                update_project_selection(false);
                                sendCommand('LIST_PROJECTS');
                            } else if (data.cmd == "HELLO" || data.cmd == "HOTPLUG") {
                                document.getElementById("server-info").value = JSON.stringify(data.payload, null, 2);
                                window.steps_per_mm = data.payload.steps_per_mm;
                                window.capabilities = data.payload.capabilities;
                                if (data.payload.client_count > 1) {
                                    window.save_usb_preview = data.payload.usbpreview;
                                } else {
                                    window.last_backlight = null   // force backlight refresh
                                }
                                adjust_capabilities(data.payload.client_count == 1)
                                if (typeof data.payload.volume_list == "undefined") {
                                    set_visible(document.getElementById("select-volume"), false);
                                    window.current_volume = true
                                }
                                var is_lan_control = typeof data.payload.lan_ip != "undefined";
                                var elem = document.getElementById("rc-qrcode");
                                set_visible(elem, is_lan_control);
                                var url = location.protocol + "//" + (is_lan_control ? data.payload.lan_ip : "localhost");
                                if (location.port != "") {
                                    url += ":" + location.port;
                                }
                                document.getElementById("rc-url").value = url;
                                var elem = document.getElementById("rc-qrcode");
                                elem.innerHTML = "";
                                if (is_lan_control) {
                                    var qrcode = new QRCode(elem, {"text": url, "height": 100, "width": 100, });
 
                                }
                                sendCommand("LIST_CAMERAS");
                                if (window.current_volume) {
                                    sendCommand("LIST_PROJECTS");
                                }
                                if (data.payload.client_count > 1) {
                                    sendCommand("GET");
                                }
                                sendCommand("GET_TEMPLATE", ["file-template-list"]);
                                document.onkeydown = do_onkeydown;
                                document.onkeyup = do_onkeyup;
                                adjust_adapter({"movement": 0, });
                            } else if (data.cmd == "LIST_CAMERAS") {
                                adjust_camera_preview(false);
                            } else if ((data.cmd == "START_PREVIEW") || (data.cmd == "STOP_PREVIEW")) {
                                document.getElementById("usb-preview-cb").checked = data.payload.usbpreview;
                            } else if (data.cmd == "GET_TEMPLATE") {
                                create_file_template(data.payload);
                                sendCommand("VALIDATE_TEMPLATE", ['project_id', 'film_id'], get_file_template_values());
                            } else if (data.cmd == "VALIDATE_TEMPLATE") {
                                adjust_file_template(data.payload);
                            }
                            adjust();
                            if (data.cmd == "DOWNLOAD") {
                                notify_update(document.getElementById("capture-count"));
                            }
                        }
                    }
                    console.log(data);
                } else {
                    update_status_info(event.data);
                }

            };

            window.control_socket.onclose = function(event) {
                if (event.wasClean && (window.control_socket.readyState != window.control_socket.CLOSED)) {
                    try {
                        window.control_socket.send(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                    } catch(err) {
                    }
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                    do_disconnect();
                }
            }

            window.control_socket.onerror = function(error) {
                console.log(`[error]`);
            };
        }
    }

    function disconnect() {
        if (typeof window.control_socket != "undefined") {
            window.control_socket.send("BYE");
            window.control_socket.onclose = function () {};
            window.control_socket.close();
            do_disconnect();
        }
    }

    function hotplug() {
        if (typeof window.control_socket != "undefined") {
            window.control_socket.send("HOTPLUG");
        }
    }

    function sendCommand2(cmd, obj) {
        if (typeof window.control_socket != "undefined" && window.control_socket.readyState == window.control_socket.OPEN) {
            if (typeof obj != "undefined") {
                cmd = cmd + ":" + JSON.stringify(obj);
            }
            update_status_info("");
            console.log('[send]: ' + cmd);
            window.control_socket.send(cmd);
        }
    }

    function sendCommand(cmd, params, obj = {}) {
        if (typeof params != "undefined") {
            params.forEach((key)=> {
                var elem = document.getElementById(key);
                if (elem.name != "") {
                    key = elem.name;
                }
                obj[key] = elem.value;
            })
        }
        sendCommand2(cmd, obj);
    }

    function do_disconnect()  {
        document.onkeydown = function(event) {};
        document.onkeyup = function(event) {};
        document.getElementById("server-info").value = "";
        delete window.control_socket;
        update_status_info("", true);
        adjust();
        adjust_adapter({});
    }

    function adjust_logger() {
        enable = document.getElementById("logger-cb").checked;
        if (typeof window.logger_socket == "undefined" && enable) {
            window.logger_socket = new WebSocket('ws://'+window._hostname+':8401');
            window.logger_socket.onopen = function(e) {
                console.log("[open] Logger connection established");
                document.getElementById("logger-cb").checked = true;
            };
            window.logger_socket.onmessage = function(event) {
                console.log(event.data);
            };

            window.logger_socket.onclose = function(event) {
                if (event.wasClean && (window.logger_socket.readyState != window.logger_socket.CLOSED)) {
                    console.log('[close] Logger connection closed');
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Logger connection died');
                    delete window.logger_socket;
                }
                document.getElementById("logger-cb").checked = false;
            }

            window.logger_socket.onerror = function(error) {
                console.log(`[error]`);
            };
        } else if (typeof window.logger_socket != "undefined" && !enable) {
            window.logger_socket.onclose = function () {};
            window.logger_socket.close();
            delete window.logger_socket;
            document.getElementById("logger-cb").checked = false;
        }
    }


    function get_adapter_button(name, dir) {
        if (dir != "") {
            name += "-" + Math.abs(dir) + (dir > 0 ? "f" : "b");
        }
        name += "-btn";
        return document.getElementById(name);
    }

    function get_radio_button_value(name) {
        var rb = document.getElementsByName(name);
        for (var i = 0; i < rb.length; i++) {
            if (rb[i].checked) {
                return rb[i].value;
            }
        }
        return null;
    }

    function is_touch_device() {
        return 'ontouchstart' in window || navigator.maxTouchPoints;
    }

    function consume_event_propagation(event) {
        event.preventDefault();   // to consume event to avoid mousedown
        event.cancelBubble = true;
        if (typeof event.stopPropagation != "undefined") {
            event.stopPropagation();
        }
    }

	function do_onresize(event) {
		// adjust zoom to avoid scrollbars in preview area
		var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
		//var height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
        var preview = document.getElementById("preview");
		var stream_container = document.getElementById("stream-container");
		var req_width = stream_container.offsetLeft + preview.scrollWidth;
		var scale = Math.max(Math.min(width / req_width, 1), 0.5);
		var cls = document.getElementsByClassName('wrapper')[0];
		cls.style["transform"] = "scale("+scale+")";
        console.log(`[onresize]: scale: ${scale}`);
	}

    function adjust_adapter_button_style(hotkeys) {
        function adj_button(btn) {
            if (hotkeys != btn.classList.contains("hotkey-enabled")) {
                btn.classList.toggle("hotkey-enabled");
            }
        }
        for (const key in window.adapter_buttons) {
            var cmd = window.adapter_buttons[key];
            if (typeof cmd.idx != "undefined") {
                for (const i in cmd.idx) {
                    adj_button(get_adapter_button(key, cmd.idx[i]));
                }
            } else {
                adj_button(get_adapter_button(key, ""));
            }
        }
    }

    function show_modal(element_id) {
        var elem = document.getElementById(element_id);
        elem.classList.add("modal-active");
    }

    function close_modal() {
        var elem = get_modal();
        if (elem) {
            elem.classList.remove("modal-active");
            adjust();
        }
    }

    function get_modal() {
        return document.querySelector(".modal-active");
    }

    function reset_input_blur_timer(input_elem) {
        if (typeof window.input_blur_timer != "undefined") {
            clearTimeout(window.input_blur_timer);
            delete window.input_blur_timer;
        }
        if (input_elem) {
            window.input_blur_timer = setTimeout(() => {
                input_elem.blur();
            }, 3000);
        }
    }

    function add_event_listeners_for_select(elem) {
        elem.addEventListener('keydown', (event) => {
            if (!get_modal()) {
                switch (event.code) {
                    case "Escape":
                    case "Enter":   // for BUTTON
                    case "ArrowRight":
                    case "ArrowLeft":
                    case "Home":
                    case "End":
                        event.preventDefault();
                        return;
                }
                if (event.target.nodeName == "SELECT") {
                    if (event.key.length == 1 && event.key.match(/[a-zA-Z0-9,\.]/)) {
                        event.preventDefault();
                        return;
                    }
                }
            }
        });
    }

    function add_event_listeners_for_input(elem) {
        elem.addEventListener('focusin', (event) => {
            if (get_modal()) {
                return;
            }
            // somohow indicate that keyboard hotkeys are not working
            adjust_adapter_button_style(false);
            reset_input_blur_timer(event.target);
        });
        elem.addEventListener('focusout', () => {
            if (get_modal()) {
                return;
            }
            // keyboards shortcuts working
            reset_input_blur_timer(null);
            adjust_adapter_button_style(true);
        });

        elem.addEventListener('keydown', (event) => {
            reset_input_blur_timer(event.target);
            event.stopPropagation();
        });
    }

    function do_onload() {
        // setup hostname
        window._hostname = location.hostname != "" ? location.hostname : "localhost";
        //window.current_usbpreview = false;
		window.onresize = do_onresize;
        window.onclick = function(event) {
            if (event.target.classList.contains("modal-active")) {
                close_modal();
            }
        }
        window.stop_multicapture = false;
        window.last_project_list_idx = null;
        window.last_film_list_idx = null;
        window.last_backlight = null;
		do_onresize(undefined);
        document.querySelectorAll(".collapse-toggle").forEach(element=> {
            element.addEventListener("click", function() {
                var elem = document.getElementById(this.getAttribute("data-container_id"));
                elem.classList.toggle("collapsed");
                this.classList.toggle("toggle-collapsed");
            })
        });
        document.querySelectorAll(".modal-open").forEach(element=> {
            element.addEventListener("click", function(event) {
                show_modal(this.getAttribute("data-modal_id"));
                consume_event_propagation(event);
            })
        });
        document.querySelectorAll(".accordion .header").forEach(element=> {
            element.addEventListener("click", function() {
                this.parentNode.classList.toggle("closed");
            })
        });

        document.querySelectorAll(".detail-toggle").forEach(element=> {
            element.addEventListener("click", function() {
                if (this.disabled || this.parentNode.disabled || this.parentNode.parentNode.disabled || this.parentNode.parentNode.parentNode.disabled) {
                    return;
                }
                var elem = document.getElementById(this.getAttribute("data-container_id"));
                elem.classList.toggle("detail");
            })
        });

        document.querySelectorAll(".modal .close").forEach(element=> {
            element.addEventListener("click", function() {
                close_modal();
            })
        });

        var multi_container = document.getElementById("file-template-options-capture-multi");
        window.multi_tags = new Tagify(multi_container.querySelector(".tags-control"), {
            "tagTextProp": "text",
            "duplicates": true,
            "editTags": false,
            "focusable": false,
            "userInput": false,
            "mode": null,
        });
        window.multi_tags.on("click", e=>{
            set_file_template_values(JSON.parse(e.detail.data.value));
            sendCommand("VALIDATE_TEMPLATE", ['project_id', 'film_id'], get_file_template_values());
        });
        window.multi_tags.has_multi = false;

        var dragsort = new DragSort(window.multi_tags.DOM.scope, {
            selector: '.'+window.multi_tags.settings.classNames.tag,
            callbacks: {
                dragEnd: function() {
                    window.multi_tags.updateValueByDOMTags();
                }
            }
        });

        document.getElementById("file-template--remove").addEventListener('click', window.multi_tags.removeAllTags.bind(window.multi_tags));
        document.getElementById("file-template--add").addEventListener('click', function() {
            var multi = {};
            var values = get_file_template_values_ex();
            var txt = [];
            for (const [key, val] of Object.entries(values["values"])) {
                if (val["multi"] && val["enabled"] && typeof val["value"] != "undefined") {
                    multi[key] = val["value"];
                    txt.push(val["text"]);
                }
            }
            if (multi) {
                window.multi_tags.addTags([{"value": JSON.stringify(multi), "text": txt.join(""), "title": txt.join(" ")}]);
            }
        });
        document.getElementById("error-close").addEventListener('click', function() {
            update_status_info("", true);
        });

        window.access_keys = {};
        /* get rid of accesskeys which does not work in browser as expected, they ignores unvisibility etc. */
        document.querySelectorAll("[accesskey]").forEach(label=>{
            const key = label.getAttribute("accesskey").toLowerCase();
            const control = document.getElementById(label.getAttribute("for"));
            if (control) {
                if (!window.access_keys[key]) {
                    window.access_keys[key] = [];
                }
                window.access_keys[key].push(control);
            }
            label.removeAttribute("accesskey");
        });

        /* global vs. focused control key override */
        document.querySelectorAll('.wrapper input[type="range"], .wrapper input[type="radio"], .wrapper select, .wrapper button').forEach(elem=> {
            add_event_listeners_for_select(elem);
        });

        document.querySelectorAll('.wrapper input[type="text"], .wrapper input[type="number"], .wrapper textarea').forEach(elem=> {
            add_event_listeners_for_input(elem);
        });

        window.settings = {
            "connection.logger": "logger-cb",
            "capture.capture.mode": "capture-mode",
            "film.notify.film_id": "notify-film-id-cb",
            "film.notify.filename": "notify-image-filename-cb",
            "preview.rotate": "rotate",
            "preview.invert": "invert-cb",
            "preview.flip": "flip-cb",
            "preview.crop.x": "crop-x-rng",
            "preview.crop.y": "crop-y-rng",
            "praview.background_color": "background-rng",
            "preview.usb": "usb-preview-cb",
            "control.autoinc": "autoinc-cb",
            "control.automove": "automove-cb",
            "control.autolead": "autolead-cb",
            "control.reverse": "reverse-cb",
            "control.sticky": "sticky-cb",
            "control.preset": "preset-list",
            "control.file_template": "file-template-list",
            "control.frame_correction": "frame-correction",
            "control.auto_correction": "autocorrection-cb",
            "control.flattening": "flattening-cb",
			"control.backlight": "backlight-cb",
			"control.backlight.color": "backlight-color-list",
			"control.backlight.white": "backlight-white-rng",
			"control.backlight.red": "backlight-red-rng",
			"control.backlight.green": "backlight-green-rng",
			"control.backlight.blue": "backlight-blue-rng",
			"control.backlight.ir": "backlight-ir-rng",
			"control.backlight.external": "backlight-external-rng",
            "capture.multi": "capture-multi",
            "capture.shoot.mode": "shoot-mode-list",
            "capture.shoot.serial_delay": "serial-shoot-delay-rng",
            "capture.shoot.trigger_delay": "trigger-delay-rng",
            "select.camera": "camera-list",
            "select.volume": "volume-list",
            "select.project": "project-list",
            "select.film": "film-list",
        };

        // add listeners for adapter
        window.adapter_buttons = {
            "move": {
                "idx": [-4, -3, -2, -1, 1, 2, 3, 4],
                "action": function(dir) {
                    window.stop_multicapture = true;
                    sendCommand2('MOVE', {'direction': dir});
                },
            },
            "stop": {
                "action": function(dir) {
                    window.stop_multicapture = true;
                    sendCommand2('STOP');
                },
            },

            "moveby": {
                "idx": [-1, 1],
                "action": function(dir) {
                    window.stop_multicapture = true;
                    sendCommand2("MOVE_BY", {'mm': dir*window.move_by_in_mm, 'speed': window.move_by_speed});
                },
            },

            "frame": {
                "idx": [-1, 1],
                "action": function(dir) {
                    window.stop_multicapture = true;
                    sendCommand2("MOVE_BY", {'mm': dir*(window.frame_width_in_mm + parseFloat(+document.getElementById('frame-correction').value || 0)), 'speed': window.frame_speed});
                },
            },

            "flatten": {
                "idx": [1, 2],
                "action": function(dir) {
                    sendCommand2("FLATTEN", {'enable': Math.abs(dir)-1});  // consider reverse which makes no sense
                },
            },

            "eject": {
                "idx": [-1, 1],
                "action": function(dir) {
                    window.stop_multicapture = true;
                    sendCommand2("EJECT", {'forward': dir});
                },
            },

            "insert": {
                "action": function(dir) {
                    window.stop_multicapture = true;
					if (!document.getElementById("film-fieldset").disabled && document.getElementById("autoinc-cb").checked) {
						var film_list = document.getElementById("film-list");
						if (film_list.selectedIndex == 0 || film_list.options[film_list.selectedIndex]._custom_data.captured.length > 0) {
							create_next_film_id();
						}
					}
                    sendCommand2('INSERT');
                },
            },

            "shoot": {
                "action": function(dir) {
                    if (window.capabilities.motorized) {
						sendCommand2("STOP");
					}
                    window.stop_multicapture = false;
                    var shoot_mode = document.getElementById("shoot-mode-list").value.split("|");
                    if (shoot_mode[0] == "capture") {
                        var params = {"wire_trigger": false, "download": shoot_mode[1].includes("download"), "delete": !shoot_mode[1].includes("sdcard")};
                    } else {
                        var delay = Number(document.getElementById("trigger-delay-rng").value) * 500;
                        var params = {"wire_trigger": true, "delay": delay, "focus+shutter": shoot_mode[1]=="f-fs"};
                    }
                    params.preset = document.getElementById("preset-list").value;
                    if (params.preset) {
                        params.negative = document.getElementById("invert-cb").checked;
                        params.flipped = document.getElementById("flip-cb").checked;
                        var val = get_radio_button_value("rotate");
                        if (val) {
                            params.rotation = Number(val.replace(/^rotate/, ""));
                        }
                    }
                    if (window.capabilities.flattening && document.getElementById("flattening-cb").checked) {
                        params.flatten = 1;
                    }
                    params.file_template = get_file_template_values();
                    sendCommand("CAPTURE", ['camera-list', 'project_id', 'film_id'], params);
                },
            },
        };


        function do_adapter_onclick(obj) {
            if (window.sticky_mouse == event.currentTarget.id) {
                // if mousedown and mouseup are invoked from the same button then unconditionally follows onclick event
                sendCommand2("STOP");
                delete window.sticky_mouse;
                return;
            }
            const arr = obj.currentTarget.id.split("-");
            var cmd = window.adapter_buttons[arr[0]];
            var dir = "";
            if (arr.length > 2) {
                dir = Number(arr[1][0]);
                if (arr[1][1] == "b") {
                    dir = -dir;
                }
                dir = reverse(dir);
            }
            cmd.action(dir);
        }

        function do_adapter_onmousedown(event) {
            console.log("[onmousedown]: "+JSON.stringify(event));
            if (document.getElementById("sticky-cb").checked) {
                event.currentTarget.click();
                window.sticky_mouse = event.currentTarget.id;
                delete window.sticky_key;
                delete window.sticky_touch;
            }
        }

        function do_adapter_onmouseup(event) {
            console.log("[onmouseup]: "+JSON.stringify(event));
            if (typeof window.sticky_mouse != "undefined") {
                // if mousedown and mouseup are invoked from the same button then uncoditionally follows onclick event
                if (window.sticky_mouse != event.currentTarget.id) {
                    sendCommand2("STOP");
                    delete window.sticky_mouse;
                }
                consume_event_propagation(event);   // to consume event to avoid page scroll
            }
        }

        function do_adapter_ontouchstart(event) {
            console.log("[ontouchstart]: "+event.currentTarget.id);
            if (document.getElementById("sticky-cb").checked) {
                // event.currentTarget.click();
                window.sticky_touch = event.currentTarget.id;
                delete window.sticky_key;
                delete window.sticky_mouse;
                event.currentTarget.click();
                consume_event_propagation(event);
            }
        }

        function do_adapter_ontouchend(event) {
            console.log("[ontouchend]: "+event.currentTarget.id);
            if (typeof window.sticky_touch != "undefined") {
                sendCommand2("STOP");
                delete window.sticky_touch;
            }
        }

        function do_adapter_ontouchcancel(event) {
            console.log("[ontouchcancel]: "+event.currentTarget.id);
            if (typeof window.sticky_touch != "undefined") {
                sendCommand2("STOP");
                delete window.sticky_touch;
            }
        }

        console.log("Touch device: " + is_touch_device())
        for (const key in window.adapter_buttons) {
            var cmd = window.adapter_buttons[key];
            if (typeof cmd.idx != "undefined") {
                for (const i in cmd.idx) {
                    get_adapter_button(key, cmd.idx[i]).onclick = do_adapter_onclick;
                }
            } else {
                get_adapter_button(key, "").onclick = do_adapter_onclick;
            }
        }
        var key = "move";
        var cmd = window.adapter_buttons[key];
        for (const i in cmd.idx) {
            var btn = get_adapter_button(key, cmd.idx[i]);
            btn.onmousedown = do_adapter_onmousedown;
            btn.onmouseup = do_adapter_onmouseup;
            if (is_touch_device()) {
                // assignment to btn.ontouchxxxx does not work
                btn.addEventListener("touchstart", do_adapter_ontouchstart, false);
                btn.addEventListener("touchend", do_adapter_ontouchend, false);
                btn.addEventListener("touchcancel", do_adapter_ontouchcancel, false);
            }
        }
        adjust_adapter_button_style(true);
        document.onmouseup = do_adapter_onmouseup;

        window.pending_settings = {};

        try {
            const RETENTION_PERIOD = 1000*60*60*24*7;
            var cps = Object.assign({}, JSON.parse(localStorage.getItem("current_project_selection")));
            window.current_project_selection = Object.keys(cps).reduce(function(volume_filtered, volume_id) {
                // filter out old records not to grow local storage
                var rec = cps[volume_id];
                cps[volume_id] = Object.keys(cps[volume_id]["updated"]).reduce(function(filtered2, project_id) {
                    if (Date.now() - cps[volume_id]["updated"][project_id] < RETENTION_PERIOD) {
                        filtered2["updated"][project_id] = cps[volume_id]["updated"][project_id];
                        filtered2["film_ids"][project_id] = cps[volume_id]["film_ids"][project_id];
                    }
                    return filtered2;
                }, {"updated": {}, "film_ids": {}, "project_id": cps[volume_id]["project_id"]});

                if (Object.keys(cps[volume_id]["updated"]).length > 0) {
                    volume_filtered[volume_id] = cps[volume_id];
                }
                return volume_filtered;
            }, {});
        } catch(err) {
            window.current_project_selection = {};
        }
        adjust();

        for (const key in window.settings) {
            var val = localStorage.getItem(key);
            var elem = document.getElementById(window.settings[key]);
            if (elem == null) {
                elems = document.getElementsByName(window.settings[key]);
                for (var i = 0; i<elems.length; i++) {
                    elem = elems[i];
                    elem.addEventListener("change", save_settings);
                    if (val === elem.value) {
                        elem.checked = true;
                    }
                }
            } else {
                elem.addEventListener("change", save_settings);
                if (val != null) {
                    if (elem.type == "select-one") {
                        window.pending_settings[elem.id] = val;   // we need set value when loaded
                        elem.value = val;
                    } else {
                        if (elem.type == "checkbox") {
                            elem.checked = val === "true";
                        } else {
                            elem.value = val;
                        }
                    }
                }
            }
        }
        window.save_usb_preview = document.getElementById("usb-preview-cb").checked;
        adjust_camera_list(localStorage.getItem("select.camera"));
        adjust_delay_value(document.getElementById("serial-shoot-delay-rng"));
        adjust_delay_value(document.getElementById("trigger-delay-rng"));
        adjust_logger();
        connect();
        adjust_preview();
    }

    function do_onkeydown(event) {
        var shift_count = Number(event.altKey) + Number(event.metaKey) + Number(event.shiftKey) + Number(event.ctrlKey);
        if (shift_count == 1 && event.altKey) {
            const key = event.key.toLowerCase();
            if (window.access_keys[key]) {
                for (const control of window.access_keys[key]) {
                    var visible = true;
                    var node = control;
                    var is_modal_control = false;
                    while (node) {
                        if (node === document) {
                            break;
                        }
                        if (node.classList.contains("modal-container")) {
                            is_modal_control = true;
                        }
                        if (control.disabled) {
                            visible = false;
                            break;
                        }
                        var style = window.getComputedStyle(node);                        
                        if (style.display === "none") {
                            visible = false;
                            break;
                        }
                        node = node.parentNode;
                    }
                    if (get_modal() && !is_modal_control) {
                        visible = false;
                    }
                    if (visible) {
                        event.preventDefault();
                        switch (control.type) {
                            case "radio":
                                if (!control.checked) {
                                    control.checked = true;
                                    control.dispatchEvent(new Event("change"));
                                }
                                break;
                            case "checkbox":
                                control.checked = !control.checked;
                                control.dispatchEvent(new Event("change"));
                                break;
                            default:
                                control.focus();                        
                        }
                        return;
                    }
                }
            }
        }

        if (get_modal()) {
            if (shift_count == 0)
            switch (event.code) {
                case "Escape":
                    close_modal();
                    break;
            }
            return;
        }
        var btn = "";
        if (shift_count == 0) {
            switch (event.code) {
            case "Escape":
            case "KeyG":
                btn = "stop";
                break;
            case "ArrowRight":
            case "KeyL":
                btn = "move-4f";
                break;
            case "KeyK":
                btn = "move-3f";
                break;
            case "KeyJ":
                btn = "move-2f";
                break;
            case "KeyH":
                btn = "move-1f";
                break;
            case "KeyF":
                btn = "move-1b";
                break;
            case "KeyD":
                btn = "move-2b";
                break;
            case "KeyS":
                btn = "move-3b";
                break;
            case "ArrowLeft":
            case "KeyA":
                btn = "move-4b";
                break;
            case "Backspace":
            case "Insert":
            case "KeyI":
                btn = "insert";
                break;
            case "Home":
            case "KeyW":
                btn = "eject-1f";
                break;
            case "End":
            case "KeyQ":
                btn = "eject-1b";
                break;
            case "Comma":
                btn = "frame-1b";
                break;
            case "Period":
                btn = "frame-1f";
                break;
            case "Numpad0":
            case "KeyX":
                btn = "shoot";
                break;
            case "KeyB":
                var cb_elem = document.getElementById("backlight-cb");
                cb_elem.checked = !cb_elem.checked;
                if (!cb_elem.disabled) {
                    cb_elem.onchange();
                }
                break;
            case "KeyP":
                document.getElementById("film_id-plus").click();
                break;
            case "KeyC":
                btn = "flatten-1f";
                break;
            case "KeyV":
                btn = "flatten-2f";
                break;
            }
        } else if (shift_count == 1) {
            switch (event.code) {
            case "ArrowRight":
                if (event.ctrlKey) {
                    btn = "frame-1f";
                } else if (event.shiftKey) {
                    btn = "move-2f";
                }
                break;
            case "ArrowLeft":
                if (event.ctrlKey) {
                    btn = "frame-1b";
                } else if (event.shiftKey) {
                    btn = "move-2b";
                }
                break;
            case "ArrowUp":
                if (event.ctrlKey) {
                    btn = "flatten-1f";
                }
                break;
            case "ArrowDown":
                if (event.ctrlKey) {
                    btn = "flatten-2f";
                }
                break;
            }
        } else if (shift_count == 2) {
            switch (event.code) {
            case "ArrowRight":
                if (event.ctrlKey && event.shiftKey) {
                    btn = "moveby-1f";
                }
                break;
            case "ArrowLeft":
            if (event.ctrlKey && event.shiftKey) {
                    btn = "moveby-1b";
                }
                break;
            }
        }
        if (btn != "") {
            if (event.repeat == false) {
                if (document.getElementById("sticky-cb").checked && (btn.indexOf("move-") == 0)) {
                    window.sticky_key = event.code;
                    delete window.sticky_mouse;
                    delete window.sticky_touch;
                }
                document.getElementById(btn+"-btn").click();
            }
            event = event || window.event;
            consume_event_propagation(event);    // to consume event to avoid page scroll
        }
        // console.log("[keydown]: "+JSON.stringify(event));
        // console.log("[keydown]: "+event.type+ "/"+elem.tagName);
    }

    function do_onkeyup(event) {
        console.log("[keyup]: "+JSON.stringify(event));
        if (window.sticky_key == event.code) {
            sendCommand2("STOP");
            delete window.sticky_key;
        }
    }

    function reverse(x) {
        if (document.getElementById("reverse-cb").checked) {
            return x;
        } else {
            return -x;
        }
    }

    function do_imgok() {
        set_visible(document.getElementById("stream-error"), false);
        set_visible(document.getElementById("stream-container"), true);
    }

    function do_imgerror() {
        set_visible(document.getElementById("stream-error"), true);
        set_visible(document.getElementById("stream-container"), false);
    }

    function set_visible(elem, value, display_on="block") {
        if (value) {
            elem.classList.remove("hidden");  // unvisible when starting
            if (display_on != "") {
                elem.style.display = display_on;
            }
        } else {
            if (display_on == "") {
                elem.classList.add("hidden");
            } else {
                elem.style.display = "none";
            }
        }
    }

    function adjust_preview() {
        var stream = document.getElementById("stream");
        var stream_control = document.getElementById("stream-control");
        var elems = stream_control.getElementsByTagName("input");
        var flip = document.getElementById("flip-cb").checked;
        for (var i = 0; i < elems.length; i++) {
            elem = elems[i];
            if (elem.type == "radio") {
                if (elem.value != "") {
                    var flip_class = "flip-" + elem.value;
                    if (!elem.checked) {
                        stream.classList.remove(elem.value, flip_class);
                    } else {
                        if (flip) {
                            stream.classList.add(flip_class);
                            stream.classList.remove(elem.value);
                        } else {
                            stream.classList.remove(flip_class);
                            stream.classList.add(elem.value);
                        }
                    }
                }
            } else if (elem.type == "checkbox") {
                if (elem.checked != stream.classList.contains(elem.value)) {
                    stream.classList.toggle(elem.value);
                }
            }
        }
        var hc = document.getElementById("crop-x-rng").value;
        var vc = document.getElementById("crop-y-rng").value;
        stream.style["clip-path"] = "inset("+vc+"px "+hc+"px "+vc+"px "+hc+"px)";
        var x = ("0"+Number(document.getElementById("background-rng").value).toString(16)).slice(-2);
        stream.parentNode.style["background-color"] = "#"+x+x+x;
    }

	function adjust_backlight(adjust_range = false, send_cmd = true) {
        var color_list = document.getElementById("backlight-color-list");
        var idx = color_list.selectedIndex;
        if (idx < 0) {
            var color = "";
        } else {
            var color = color_list.options[idx].value;
        }
        var val = 0;
		var is_on = (color != "") && document.getElementById("backlight-cb").checked;
        var elems = document.getElementById("backlight-color-ranges").getElementsByTagName("div");
        for (var i = 0; i < elems.length; i++) {
            var elem_color = elems[i].id.split("-")[1];
            var is_visible = color.includes(elem_color);
            if (adjust_range) {
                set_visible(elems[i], is_visible, "");
            }
            var range_elem = document.getElementById("backlight-"+elem_color+"-rng");
            document.getElementById("backlight-"+elem_color+"-value").innerHTML = range_elem.value;
            if (is_on && is_visible) {
                val *= 256;  // bitwise operators are 32-bit only!
                val += Number(range_elem.value);
            }
        }
        if (send_cmd) {
            var bck = `${is_on}`;
            if (is_on) {
                bck += `:${val}`;
            }
            if (window.last_backlight !== bck) {
                // avoid flooding when switched off and moving slidebar
                window.last_backlight = bck;
                if (is_on) {
                    sendCommand2("SET_BACKLIGHT", {"color": color, "intensity": val});
                } else {
                    sendCommand2("SET_BACKLIGHT");
                }
            }
        }
	}

    function adjust_delay_value(range_elem) {
        var value_elem = document.getElementById(range_elem.id.replace("-rng", "-value"));
        value_elem.innerHTML = String(Number(range_elem.value) * 0.5)+"s";
    }

    function create_file_template(tpl) {
        var containers = [];
        ["film", "capture"].forEach(name=>{
            containers[name] = document.getElementById("file-template-options-"+name);
            containers[name].innerHTML = "";
        });
        var is_multi = false;
        for (const [part_id, part] of Object.entries(tpl.parts)) {
            var input;
            var input_container = null;
            var len = 0;
            var val = localStorage.getItem("file_template."+part_id);
            if (part.type == "enum") {
                input = document.createElement("select");
                var valid = false;
                part.values.forEach(opt=>{
                    var option = new Option(opt.name, opt.id);
                    if (opt.id === val) {
                        valid = true;
                    }
                    input.add(option);
                    if (opt.name.length > len) {
                        len = opt.name.length;
                    }
                });
                len += 2;
                if (!valid) {
                    val = null;
                }
                add_event_listeners_for_select(input);

            } else if (part.type == "string") {
                input = document.createElement("input");
                input.type = "text";
                if (typeof part.max_length != "undefined") {
                    input.maxLength = part.max_length;
                    len = part.max_length;
                } else {
                    len = 10;
                }
                add_event_listeners_for_input(input);

            } else if (part.type == "datetime") {
                input = document.createElement("input");
                input.type = "text";
                len = 17;
                add_event_listeners_for_input(input);

            } else if (part.type == "number") {
                input = document.createElement("input");
                input.type = "number";
                input.step = 1;
                if (typeof part.min != "undefined") {
                    input.min = part.min;
                } else {
                    input.min = 1;
                }
                if (typeof part.max != "undefined") {
                    input.max = part.max;
                } else {
                    input.max = 9999;
                }
                input.value = input.min;
                len = Math.max(String(input.min).length, String(input.max).length) + 2;
                add_event_listeners_for_input(input);

            } else if (part.type == "counter") {
                input_container = document.createElement("span");
                input = document.createElement("input");
                input.type = "number";
                input.step = 1;
                input.min = 1;
                input.id = "file-template--input--"+part_id;
                if (typeof part.max != "undefined") {
                    input.max = part.max;
                } else {
                    input.max = 9999;
                }
                input.value = input.min;
                input_container.appendChild(input);
                var icon = document.createElement("span");
                icon.classList.add("hidden");
                icon.classList.add("icon");
                icon.innerHTML = "&#9888;"
                input_container.appendChild(icon);
                len = String(input.max).length + 2;
                add_event_listeners_for_input(input);

            } else if (part.type == "bool") {
                input_container = document.createElement("span");
                input = document.createElement("input");
                input.type = "checkbox";
                input.value = "1";
                input.id = "file-template--checkbox--"+part_id;
                input.setAttribute("data-values", JSON.stringify(part.values));
                add_event_listeners_for_input(input);
                input_container.appendChild(input);
                var label = document.createElement("label");
                label.setAttribute("for", input.id);
                label.innerHTML = part.name;
                input_container.appendChild(label);
                len = 2;

            } else {
                return;
            }
            if (!input_container) {
                input_container = input;
            };
            input.setAttribute("data-type", part.type);
            input_container.id = "file-template--"+part_id;
            input_container.classList.add("file-template--"+part.type);
            input.name = part_id;
            if (typeof part.description != "undefined")  {
                input.title = part.description;
            } else if (typeof part.name != "undefined")  {
                input.title = part.name;
            }
            input.style.width = String(len)+"ch";
            if (typeof part.multi != "undefined" && part.multi) {
                is_multi = true;
                input.setAttribute("data-multi", part.multi);
            }

            if (val != null) {
                input.value = val;
            }
            input.addEventListener("change", function() {
                localStorage.setItem("file_template."+this.name, this.value);
                sendCommand("VALIDATE_TEMPLATE", ['project_id', 'film_id'], get_file_template_values());
            });

            containers[typeof part.container != "undefined" ? part.container : "film"].appendChild(input_container);
        }
        var multi_container = document.getElementById("file-template-options-capture-multi");
        window.multi_tags.has_multi = is_multi;
        if (is_multi) {
            multi_container.classList.remove("hidden");
        } else {
            multi_container.classList.add("hidden");

        }        
    }

    function set_file_template_values(values) {
        var opts = [
            ...document.getElementById("file-template-options-film").querySelectorAll("input, select"),
            ...document.getElementById("file-template-options-capture").querySelectorAll("input, select")
            ];
        opts.forEach(elem=>{
            if (typeof values[elem.name] != "undefined") {
                if (elem.type == "checkbox") {
                    elem.checked = values[elem.name];
                } else {
                    elem.value = values[elem.name];
                }

            }
        });
    }

    function get_file_template_values_ex() {
        var values = {};
        var opts = [
            ...document.getElementById("file-template-options-film").querySelectorAll("input, select"),
            ...document.getElementById("file-template-options-capture").querySelectorAll("input, select")
            ];
        opts.forEach(elem=>{
            var val = {};
            val["multi"] = elem.getAttribute("data-multi") === "true";
            val["enabled"] = !document.getElementById("file-template--"+elem.name).classList.contains("hidden");
            if (elem.type == "checkbox") {
                val["value"] = elem.checked ? 1 : 0;
                var v = JSON.parse(elem.getAttribute("data-values"));
                val["text"] = Object.values(v)[val["value"]];
            } else if (typeof elem.value != "undefined") {
                val["value"] = elem.value;
                if (elem.type == "enum") {
                    if (elem.selectedIndex >= 0) {
                        val["text"] = elem.options[elem.selectedIndex].text;
                    }

                } else {
                    val["text"] = val["value"];
                }
            }
            values[elem.name] = val;
        });
        return {"template_id": document.getElementById("file-template-list").value, "values": values};
    }

    function get_file_template_values() {
        var data = get_file_template_values_ex();
        var values = {};
        Object.keys(data["values"]).forEach(key=>{
            if (typeof data["values"][key]["value"] != "undefined") {
                values[key] = data["values"][key]["value"];
            }
        })
        return {"template_id": data["template_id"], "values": values};
    }

    function adjust_file_template(tpl) {
        for (const [part_id, part] of Object.entries(tpl.parts)) {
            var elem = document.getElementById("file-template--"+part_id);
            if (elem) {
                if (part.enabled === true) {
                    elem.classList.remove("hidden");
                } else if (part.enabled === false) {
                    elem.classList.add("hidden");
                }
                var icon = elem.querySelector(".icon");
                if (icon) {
                    var input = elem.querySelector("input");
                    if ((typeof part.value == "undefined") || input.value === String(part.value)) {
                        icon.classList.add("hidden");
                        icon.setAttribute("title", "");
                    } else {
                        icon.classList.remove("hidden");
                        icon.setAttribute("title", `Next value: ${part.value}`);
                    }
                }
            }
        }
        document.getElementById("header-capture-filename").innerHTML = tpl.filename;
        tpl.actions.forEach(action => {
            if (action.type == "set") {
                switch (action.entity) {
                    case "led":
                        var elem = document.getElementById("backlight-color-list");
                        // check if enabled ??
                        elem.value = action.value;
                        adjust_backlight(true);
                        break;
                    case "preset":
                        var elem = document.getElementById("preset-list");
                        elem.value = action.value;
                        break;
                    case "autoinc":
                        var elem = document.getElementById("autoinc-cb");
                        elem.checked = action.value;
                        break;
                    case "invert":
                    case "flip":
                        var elem = document.getElementById(action.entity+"-cb");
                        elem.checked = action.value;
                        adjust_preview();
                        break;
                    case "rotate":
                        var elem = document.getElementById("rotate"+String(action.value)+"-rb");
                        if (elem) {
                            elem.checked = true;
                        }
                        adjust_preview();
                        break;
                }
            }
        });

        if (document.getElementById("film_id").value != "") {
            var errs = [];
            if (typeof tpl.errors != "undefined") {
                for (const [part_id, err] of Object.entries(tpl.errors)) {
                    errs.push(`${part_id}: ${err}`);
                }
            }
            update_status_info(errs.join("|"));
        }
    }

    function update_project_selection(film_update) {
        var rec = Object.assign({"updated": {}, "film_ids": {}}, window.current_project_selection[window.current_volume],
            {"project_id": document.getElementById("project-list").value, })
        rec["updated"][rec["project_id"]] = Date.now();
        if (film_update) {
            rec["film_ids"][rec["project_id"]] = document.getElementById("film-list").value;
        }
        window.last_project_list_idx = null;
        window.current_project_selection[window.current_volume] = rec;
        localStorage.setItem("current_project_selection", JSON.stringify(window.current_project_selection));
    }

    function save_settings(event) {
        var elem = event.srcElement;
        for (const key in window.settings) {
            if (elem.id == window.settings[key]) {
                var val;
                if (elem.type == "checkbox") {
                    val = elem.checked;
                } else if (elem.type  == "radio") {
                    if (elem.checked) {
                        val = elem.checked;
                    }
                } else {
                    val = elem.value;
                }
                localStorage.setItem(key, val);
            } else if (elem.type  == "radio" && elem.name==window.settings[key]) {
                if (elem.checked) {
                    localStorage.setItem(key, elem.value);
                }
            }
        }
    }

</script>
</html>
