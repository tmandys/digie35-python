<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-png" href="images/digie35-scanner-96.png" />
    <title>Digie35 Adapter Test Client</title>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif
        }

        .sidebar {
            width: 200px;
            padding: 10px;
            margin: 5px 0;
            border: none;
            background: #ddd;
            cursor: pointer;
            text-align: left;
        }

        .sidebar button {
            width: 100%;
        }

        .sidebar button:hover {
            background:  #bbb;
        }

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .content .section .header {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .main-content {
            flex-grow: 1;

        }

        .section, .hidden-tab, .hidden {
            display: none;
        }

        .active {
            display: block;
        }

        /*.control-container {
                display: flex;
        }

        .control-container label {
            min-width:120px;
            text-align: right;
        }*/

        .dropdown-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-open .dropdown-content {
            display: block !important;
        }

        .dropdown-container input {
            width: 100%;
            box-sizing: border-box;
            padding-right: 15px;
        }

        .dropdown-container .arrow {
            font-size: 14px;
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s;
            /*pointer-events: none;*/
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .dropdown-content {
            font-size: 0.8em;
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #333;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
        }

        .dropdown-content div:hover {
            background-color: #f1f1f1;
        }

        .dropdown-content .selected {
            background-color: #a1a1a1;
        }

        .log-area {
            height: 100px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            overflow-y: auto;
            border-top: 2px solid #666;
            white-space: pre-wrap;
            min-height: 100px;
        }

        .tree-menu {
            list-style-type: none;
            padding-left: 0;
        }

        .tree-menu > li {
            margin: 10px 0;
        }

        .submenu {
            list-style-type: none;
            padding-left: 20px;
        }

        .tree-menu a {
            text-decoration: none;
            color: #000;
            cursor: pointer;
        }

        .tree-menu .menu-item {
            font-weight: bold;
        }

        .tree-menu a:hover {
            color: #007bff;
        }

        .collapsed .submenu {
            display: none;
        }

        .tree-menu .arrow {
            display: inline-block;
            margin-right: 5px;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .tree-menu .collapsed .arrow {
            transform: rotate(-90deg);
        }

        .form-container {
            display: grid;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 150px 1fr;
            column-gap: 10px;
            align-items: start;
        }

        .form-row label {
            text-align: right;
        }

        .form-row .hint {
            display: block;
            font-size: 0.7em;
            color: gray;
            margin-top: 3px;
        }

        .input-container input {
            width: 100%;
            box-sizing: border-box;
        }

        .button-container {
            display: flex;
            justify-content: left; /* right is wrong when box#2 is hidden */
            padding: 5px;
        }
        .button-container button {
            margin-left: 10px;
        }

        .section .box-container {
            display: grid;
            gap: 10px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 600px) {
            .section .box-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .section .xbox {
            padding: 2px;
            text-align: center;
        }

    </style>

</head>

<body onload="do_onload()">

    <div class="sidebar">
        <ul class="tree-menu">
            <li>
                <a href="#" class="menu-item toggle">Connection</a>
                <span class="arrow">&#9660;</span>
                <ul class="submenu">
                    <li>
                        <button onclick="connect()">Connect</button>
                        <button onclick="disconnect()">Disconnect</button>
                        <button onclick="sendCommand('HOTPLUG')">Hotplug</button>
                    </li>
                </ul>
            </li>
            <li class="">  <!-- potentially collapsed -->
                <a href="#" id="menu-eeprom" class="menu-item toggle">Configuration</a>
                <span class="arrow">&#9660;</span>
                <ul class="submenu">
                    <li>
                        <a href="#" onclick="showSection('eeprom-XBOARD')">X-Board</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('eeprom-ADAPTER')">Adapter</a>
                    </li>
                    <li>
                        <a href="#" onclick="showSection('eeprom-LIGHT')">Light</a>
                    </li>
                </ul>
            </li>
            <li>
                <a href="#" class="menu-item" onclick="showSection('obsolete')">Obsolete</a>
                <span class="arrow">&raquo;</span>
            </li>
        </ul>
    </div>
    <div class="content">
        <div class="main-content">
            <div id="connection" class="section active">
            </div>

            <div id="eeprom-XBOARD" class="section eeprom">
                <div class="header">X-Board configuration</div>
                <div class="box-container">
                    <div class="box">                    
                        <fieldset id="eeprom-XBOARD-COMMON" class="eeprom-common">
                            <legend>Common</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                    <div class="box">                    
                        <fieldset id="eeprom-XBOARD-MAIN" class="eeprom-board hidden-tab">
                            <legend>Main</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                </div>
                <div class="button-container">
                    <button onclick="eepromSetDefault('XBOARD');" title="Set default values">Default</button>
                    <button onclick="eepromLoad('XBOARD');" title="Load values from board">Load</button>
                    <button onclick="eepromSave('XBOARD');" title="Save values to board">Save</button>
                </div>
            </div>

            <div id="eeprom-ADAPTER" class="section eeprom">
                <div class="header">Adapter board configuration</div>
                <div class="box-container">
                    <div class="box">                    
                        <fieldset id="eeprom-ADAPTER-COMMON" class="eeprom-common">
                            <legend>Common</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                    <div class="box">                    
                        <fieldset id="eeprom-ADAPTER-STEPPER" class="eeprom-board hidden-tab">
                            <legend>Stepper</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                        <fieldset id="eeprom-ADAPTER-NIKON" class="eeprom-board hidden-tab">
                            <legend>Nikon</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                        <fieldset id="eeprom-ADAPTER-MANUAL" class="eeprom-board hidden-tab">
                            <legend>Manual</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                </div>
                <div class="button-container">
                    <button onclick="eepromSetDefault('ADAPTER');" title="Set default values">Default</button>
                    <button onclick="eepromLoad('ADAPTER');" title="Load values from board">Load</button>
                    <button onclick="eepromSave('ADAPTER');" title="Save values to board">Save</button>
                </div>
            </div>

            <div id="eeprom-LIGHT" class="section eeprom">
                <div class="header">Light board configuration</div>
                <div class="box-container">
                    <div class="box">                    
                        <fieldset id="eeprom-LIGHT-COMMON" class="eeprom-common">
                            <legend>Common</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                    <div class="box">                    
                        <fieldset id="eeprom-LIGHT-LGHT8PWM" class="eeprom-board hidden-tab">
                            <legend>8xPWM</legend>
                            <div class="control-container form-container"></div>
                        </fieldset>
                    </div>
                    <div class="button-container">
                        <button onclick="eepromSetDefault('LIGHT');" title="Set default values">Default</button>
                        <button onclick="eepromLoad('LIGHT');" title="Load values from board">Load</button>
                        <button onclick="eepromSave('LIGHT');" title="Save values to board">Save</button>
                    </div>
                </div>
            </div>

            <div id="obsolete" class="section">
                <fieldset>
                    <legend>Transport</legend>
                    <button onclick="sendCommand('MOVE:-4')">&lt;&lt;&lt;&lt;</button>
                    <button onclick="sendCommand('MOVE:-3')">&lt;&lt;&lt;</button>
                    <button onclick="sendCommand('MOVE:-2')">&lt;&lt;</button>
                    <button onclick="sendCommand('MOVE:-1')">&lt;</button>
                    <button onclick="sendCommand('STOP')">STOP</button>
                    <button onclick="sendCommand('MOVE:1')">&gt;</button>
                    <button onclick="sendCommand('MOVE:2')">&gt;&gt;</button>
                    <button onclick="sendCommand('MOVE:3')">&gt;&gt;&gt;</button>
                    <button onclick="sendCommand('MOVE:4')">&gt;&gt;&gt;&gt;</button>
                    <br />
                    <br />
                    <button onclick="sendCommand('INSERT')">LEAD-IN FILM</button>
                    <button onclick="sendCommand('EJECT:-1')">&lt; EJECT FILM</button>
                    <button onclick="sendCommand('EJECT:1')">EJECT FILM &gt;</button>
                    <button onclick="sendCommand('MOVE_BY:-36:4')">&lt; MOVE BY FRAME</button>
                    <button onclick="sendCommand('MOVE_BY:36:4')">MOVE BY FRAME &gt;</button>
                </fieldset>
                <br />
                <fieldset>
                    <legend>Outputs</legend>
                    <button onclick="sendCommand('PULSE:FOCUS:0.5')">FOCUS</button>
                    <button onclick="sendCommand('PULSE:SHUTTER:0.5')">SHUTTER</button>
                    <button onclick="sendCommand('PULSE:FOCUS:0.5:1.0|PULSE:SHUTTER:0.5:0.5')">FOCUS &amp; SHUTTER</button>
                    <button onclick="sendCommand('LEVEL:FOCUS:1|WAIT:0.5|LEVEL:FOCUS:0|LEVEL:SHUTTER:1|WAIT:0.5|LEVEL:SHUTTER:0')">FOCUS &amp; SHUTTER (wait)</button>
                    <br />
                    <br />
                    <button onclick="sendCommand('LEVEL:RESERVE:1')">RESERVE ON</button>
                    <button onclick="sendCommand('LEVEL:RESERVE:0')">RESERVE OFF</button>
                    <button onclick="sendCommand('LEVEL:SHUTTER:1')">SHUTTER ON</button>
                    <button onclick="sendCommand('LEVEL:SHUTTER:0')">SHUTTER OFF</button>
                    <button onclick="sendCommand('LEVEL:FOCUS:1')">FOCUS ON</button>
                    <button onclick="sendCommand('LEVEL:FOCUS:0')">FOCUS OFF</button>
                    <button onclick="sendCommand('LEVEL:PSU_LED:1')">PSU LED  ON</button>
                    <button onclick="sendCommand('LEVEL:PSU_LED:0')">PSU LED OFF</button>
                    <br />
                    <br />
                    <label for="led_pwm">PWM<input type="number" id="led_pwm" min="0" max="100" value="50" /></label>
                    <button onclick="sendCommand('SET_BACKLIGHT:WHITE:'+document.getElementById('led_pwm').value)">SET WHITE</button>
                    <button onclick="sendCommand('SET_BACKLIGHT:EXTERNAL:'+document.getElementById('led_pwm').value)">SET EXTERNAL</button>
                </fieldset>
                <br />
                <fieldset>
                    <legend>Simulator</legend>
                        <button onclick="sendCommand('SENSOR:SENSOR_F:1')">FRONT ON</button>
                        <button onclick="sendCommand('SENSOR:SENSOR_F:0')">FRONT OFF</button>
                        <button onclick="sendCommand('SENSOR:SENSOR_R:1')">REAR ON</button>
                        <button onclick="sendCommand('SENSOR:SENSOR_R:0')">REAR OFF</button>
                        <button onclick="sendCommand('SENSOR:SENSOR_M:1')">MIDDLE ON</button>
                        <button onclick="sendCommand('SENSOR:SENSOR_M:0')">MIDDLE OFF</button>
                        <button onclick="sendCommand('SENSOR:DETECT_AOT:1')">ADAPTER ON</button>
                        <button onclick="sendCommand('SENSOR:DETECT_AOT:0')">ADAPTER OFF</button>
                        <button onclick="sendCommand('SENSOR:JACK:1')">JACK ON</button>
                        <button onclick="sendCommand('SENSOR:JACK:0')">JACK OFF</button>
                </fieldset>
                <br />
                <fieldset>
                    <legend>Misc</legend>
                    <button onclick="sendCommand('GET')">GET</button>
                </fieldset>
                <hr />

                <fieldset>
                    <legend>Inputs</legend>
                        <div><input type="checkbox" id="film_detected" disabled="disabled" /><label for="film_detected">Film detected</label></div>
                        <div><input type="checkbox" id="frame_ready" disabled="disabled" /><label for="frame_ready">Film ready</label></div>
                        <div><input type="checkbox" id="io.sensor_f" disabled="disabled" /><label for="io.sensor_f">FRONT</label></div>
                        <div><input type="checkbox" id="io.sensor_r" disabled="disabled" /><label for="io.sensor_r">REAR</label></div>
                        <div><input type="checkbox" id="io.sensor_m" disabled="disabled" /><label for="io.sensor_m">MIDDLE</label></div>
                        <div><input type="checkbox" id="io.detect_aot" disabled="disabled" /><label for="io.detect_aot">MIDDLE-ADAPTER</label></div>
                        <div><input type="checkbox" id="io.jack" disabled="disabled" /><label for="io.jack">JACK</label></div>
                </fieldset>
                <fieldset>
                    <legend>Outputs</legend>
                        <div><label>Movement<input type="number" id="movement" disabled="disabled" /></label></div>
                        <div><input type="checkbox" id="io.focus" disabled="disabled" /><label for="io.focus">FOCUS</label></div>
                        <div><input type="checkbox" id="io.shutter" disabled="disabled" /><label for="io.shutter">SHUTTER</label></div>
                        <div><input type="checkbox" id="io.reserve" disabled="disabled" /><label for="io.reserve">RESERVE</label></div>
                        <div><input type="checkbox" id="io.psu_led" disabled="disabled" /><label for="io.psu_led">PSU LED</label></div>
                </fieldset>
                <fieldset>
                    <legend>Counters</legend>
                        <div><label>Motor<input type="number" id="counters.motor" disabled="disabled" /></label></div>
                        <div><label>FRONT<input type="number" id="counters.front" disabled="disabled" /></label></div>
                        <div><label>REAR<input type="number" id="counters.rear" disabled="disabled" /></label></div>
                        <div><label>WINDOW<input type="number" id="counters.window" disabled="disabled" /></label></div>
                </fieldset>
                <div id="info"></div>


            </div>
        </div>
        <div class="log-area" id="log"></div>
    </div>
</body>

<script>
    function do_onload() {
        document.querySelectorAll(".toggle").forEach(element=> {
            element.addEventListener("click", function(e) {
                e.preventDefault();
                const elem = this.parentNode; // nextElementSibling;
                elem.classList.toggle("collapsed");
            })
        });

    }

    function showSection(sectionId) {
        document.querySelectorAll(".section").forEach(section => {
            section.classList.remove("active");
        });
        document.getElementById(sectionId).classList.add("active");
    }

    function addLog(message) {
        const logArea = document.getElementById("log");
        const time = new Date().toLocaleTimeString();
        logArea.textContent += `[${time}] ${message}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function sendCommand(cmd) {
        console.log(`sendCommand: ${cmd}`);
        window.socket.send(cmd);
    }

    function prepareEepromSection(board_id, params) {
        var container = document.getElementById("eeprom-"+board_id);
        if (container == undefined) {
            addLog(`Unsupported board: ${board_id}`);
            return;
        }
        var container2 = container.querySelector(".control-container");
        container2.replaceChildren();
        if (params) {
            params.forEach(items => {
                if (items[0] != null) {
                    let label = document.createElement("label");
                    let id = "eeprom-"+board_id+"-"+items[0];
                    label.setAttribute("for", id);
                    label.textContent = items[0];

                    let input = document.createElement("input");
                    input.type = "text";
                    switch (items[1]) {
                        case "string":
                        case "STRING":
                            input.type = "text";
                            input.maxLength = items[2];
                            break;
                        case "number":
                            input.type = "number";
                            input.step = 1;
                            input.min = 0;
                            input.max = 2**(items[2]*8) - 1;
                            break;
                        case "int":
                            input.type = "number";
                            input.step = 1;
                            input.max = 2**(items[2]*8) / 2 -1;
                            input.min = -input.max + 2;
                            break;
                        default:
                            input.type = "text";
                        }
                    input.setAttribute("data-type", items[1]);
                    input.id = id;
                    input.name = items[0];
                    // input.title = items[3];
                    if ((items.length >= 5) && items[4] && (items[4].toString() != "")) {
                        input.setAttribute("placeholder", items[4]);
                        input.setAttribute("data-default", items[4]);
                    }

                    if (items.length >= 6) {
                        let div1 = document.createElement("div");
                        div1.classList.add("dropdown-container");
                        div1.appendChild(input);
                        let arrow = document.createElement("span");
                        arrow.innerHTML = "&#9660;";
                        arrow.classList.add("arrow");
                        div1.appendChild(arrow);
                        let div2 = document.createElement("div");
                        div2.classList.add("dropdown-content");
                        div1.appendChild(div2);
                        opts = items[5];
                        if (Array.isArray(opts)) {
                            opts.forEach(opt => {
                                let opt_div = document.createElement("div");
                                opt_div.classList.add("option");
                                opt_div.setAttribute("data-value", opt);
                                opt_div.innerHTML = `${opt}`;
                                div2.appendChild(opt_div);
                            });
                        } else {
                            Object.keys(opts).forEach(opt => {
                                let opt_div = document.createElement("div");
                                opt_div.classList.add("option");
                                let opt2 = opt.trim(); // json sorts numeric keys so space artificially added to avoid sorting
                                opt_div.setAttribute("data-value", opt2);                                
                                opt_div.innerHTML = opts[opt]+ ` (${opt2})`;
                                div2.appendChild(opt_div);
                            });
                        }
                        input = div1;
                    }
                    let div = document.createElement("div");
                    div.classList.add("form-row");
                    let div_ic = document.createElement("div");
                    div_ic.classList.add("input-container");
                    div_ic.appendChild(input);
                    let hint = document.createElement("small");
                    hint.classList.add("hint");
                    hint.innerHTML = items[3];
                    div_ic.appendChild(hint);

                    div.appendChild(label);
                    div.appendChild(div_ic);

                    container2.appendChild(div);
                }
            });
        }
    }

    function eepromSetDefault(board_type) {
        var board_id = document.getElementById("eeprom-"+board_type+"-COMMON-adapter_id").value;
        var inputs = document.getElementById("eeprom-"+board_type).querySelectorAll(".control-container input");
        inputs.forEach(input=>{
            if (input.id.includes("-COMMON-") || input.id.includes("-"+board_id+"-")) {
                var def = input.getAttribute("data-default");
                if (def != null && def != input.value) {
                    input.value = def;
                    input.dispatchEvent(new Event("change", {bubbles: true}));
                }
            }
        });
    }

    function eepromSave(board_type) {
        sendCommand("WRITE_EEPROM", {
            "board_type": board_type,
            "common": getEepromControls(board_type, "COMMON"),
            "board": getEepromControls(board_type, document.getElementById("eeprom-"+board_type+"-COMMON-adapter_id").value),
        });
    }

    function eepromLoad(board_type) {
        sendCommand("READ_EEPROM", {"board_type": board_type});

        var inputs = document.getElementById("eeprom-"+board_type).querySelectorAll(".control-container input");
        inputs.forEach(input=>{
            var def = input.getAttribute("data-default");
            if (def != null && def != input.value) {
                input.value = def;
                input.dispatchEvent(new Event("change", {bubbles: true}));
            }
        });
    }

    function getEepromControls(board_type, board_id) {
        var data = {};
        var container = document.getElementById("eeprom-"+board_type+"-"+board_id);
        if (container) {
            var inputs = container.querySelectorAll(".control-container input");
            inputs.forEach(input=>{
                switch (input.getAttribute("data-type")) {
                    case "int":
                    case "number":
                        if (input.value == "") {
                            data[input.name] = null
                        } else {
                            data[input.name] = Number(input.value);
                        }
                        break;
                    default:
                        data[input.name] = input.value;
                }
            });
        }
        return data;
    }

    function updateEepromControls(board_type, board_id, data) {
        Object.keys(data).forEach(key => {
            var input = document.getElementById("eeprom-"+board_type+"-"+board_id+"-"+key);
            if (!input) {
                addLog(`Control not found: ${board_type}-${board_id}-${key}`);
            } else {
                if (input.value !== data[key]) {
                    input.value = data[key];
                    input.dispatchEvent(new Event("change", {bubbles: true}));
                }
            }
        });
    }

    function adjustAdapterId() {
        BOARD_TYPES.forEach(board_type => {
            const adapter_id = document.getElementById("eeprom-"+board_type+"-COMMON-adapter_id").value;
            const container = document.getElementById("eeprom-"+board_type);
            container.querySelectorAll(".eeprom-board").forEach(element=> {
                if (element.id == "eeprom-"+board_type+"-"+adapter_id) {
                    element.classList.remove("hidden-tab");
                } else {
                    element.classList.add("hidden-tab");
                }
            });
        });
    }

    function adjustSelectedDropdownItem(container) {
        var input = container.querySelector("input");
        var options = container.querySelectorAll(".dropdown-content .option");
        options.forEach(element=> {
            if (element.getAttribute("data-value") === input.value) {
                element.classList.add("selected");
            } else {
                element.classList.remove("selected");
            }
        });

    }

    const BOARD_TYPES = ["XBOARD", "ADAPTER", "LIGHT"]

    function connect() {
        if (typeof window.socket == "undefined") {
            window.socket = new WebSocket('ws://localhost:8401');
            window.socket.onopen = function(e) {
                console.log("[open] Connection established");
                sendCommand("HELLO");
            };
            window.socket.onmessage = function(event) {
                console.log(`[message] Data received from server: ${event.data}`);
                if (event.data[0] == "{") {
                    var data = JSON.parse(event.data);
                    console.log(data);
                    var cmd = data.cmd;
                    data = data.payload;

                    if (cmd == "HELLO") {
                        addLog(event.data);
                        var cfg = document.getElementById("menu-eeprom");
                        if (data.eeprom) {
                            sendCommand("GET_CONFIG");
                            cfg.classList.remove("hidden")
                        } else {
                            cfg.classList.add("hidden");
                        }

                    } else if (cmd == "GET_CONFIG") {
                        prepareEepromSection("XBOARD-MAIN", data.eeprom["MAIN"]);
                        data.adapter_boards.forEach(board_id => {
                            prepareEepromSection("ADAPTER-" + board_id, data.eeprom[board_id]);
                        });
                        data.light_boards.forEach(board_id => {
                            prepareEepromSection("LIGHT-" + board_id, data.eeprom[board_id]);
                        });
                        var adapter_ids = {
                            "XBOARD": ["MAIN"],
                            "ADAPTER": data.adapter_boards,
                            "LIGHT": data.light_boards,
                        };
                        var adapter_id_idx = -1;
                        for (var i=0; i < data.eeprom["COMMON"].length; i++) {
                            if (data.eeprom["COMMON"][i][0] == "adapter_id") {
                                adapter_id_idx = i;
                                break;
                            }
                        }
                        BOARD_TYPES.forEach(board_type => {
                            data.eeprom["COMMON"][adapter_id_idx][5] = adapter_ids[board_type];
                            prepareEepromSection(board_type+"-COMMON", data.eeprom["COMMON"]);
                            const el = document.getElementById("eeprom-"+board_type+"-COMMON-adapter_id");
                            el.addEventListener("change", function(event) {
                                adjustAdapterId();
                            });
                        });
                        adjustAdapterId();

                        document.querySelectorAll(".control-container input").forEach(el => {
                            el.onfocus = function(event) {
                                document.querySelectorAll(".dropdown-container").forEach(el2 => {
                                    el2.classList.remove("dropdown-open");
                                });
                            };
                            el.oninput = function(event) {
                                var input = this;

                                switch (input.getAttribute("data-type")) {
                                    case "STRING":
                                        input.value = input.value.toUpperCase();
                                    case "string":
                                        input.value = input.value.replace(/[^A-Z0-9_a-z]/g, "");
                                        break;
                                }
                                adjustSelectedDropdownItem(input.parentNode);
                            };
                        });

                        document.querySelectorAll(".dropdown-container .arrow").forEach(el => {
                            el.onclick = function(event) {
                                document.querySelectorAll(".dropdown-container").forEach(el2 => {
                                    if (el2 != this.parentNode) {
                                        el2.classList.remove("dropdown-open");
                                    }
                                });
                                adjustSelectedDropdownItem(this.parentNode);
                                this.parentNode.classList.toggle("dropdown-open");
                                if (this.parentNode.classList.contains("dropdown-open")) {
                                    // when closing not to reopen in onfocus
                                    this.parentNode.querySelector("input").focus();
                                }
                                event.stopPropagation();
                            };
                        });

                        document.querySelectorAll(".section").forEach(el => {
                            el.onclick = function(event) {
                                this.querySelectorAll(".dropdown-container").forEach(el2 => {
                                    el2.classList.remove("dropdown-open");
                                });
                            };
                        });

                        document.querySelectorAll(".dropdown-container input").forEach(el => {
                            el.onfocus = function(event) {
                                document.querySelectorAll(".dropdown-container").forEach(el2 => {
                                     el2.classList.remove("dropdown-open");
                                });
                                adjustSelectedDropdownItem(this.parentNode);
                                this.parentNode.classList.add("dropdown-open");
                            };
                            el.onclick = function(event) {
                                event.stopPropagation();   // not to pass to div
                            }
                            el.addEventListener("focusout", function(event) {
                                document.querySelectorAll(".dropdown-container").forEach(el2 => {
                                    //el2.classList.remove("dropdown-open");   // TODO: option onclick is not triggered, currently done in onfocus of all inputs
                                });
                            });
                            el.onkeydown = function(event) {
                                var input = this;
                                if (!event.shiftKey && !event.metaKey && !event.ctrlKey) {
                                    var inc = 0;
                                    if (!event.altKey) {
                                        switch (event.key) {
                                            case "ArrowDown":
                                                inc = 1;
                                                event.preventDefault();
                                                break;
                                            case "ArrowUp":
                                                inc = -1;
                                                event.preventDefault();
                                                break;
                                            case "Escape":
                                            case "Enter":
                                                input.parentNode.classList.remove("dropdown-open");
                                                break;
                                        }
                                    } else {
                                        switch (event.key) {
                                            case "ArrowDown":
                                            case "ArrowUp":
                                                input.parentNode.querySelector(".arrow").dispatchEvent(new Event("click", {bubbles: true}));
                                                event.preventDefault();
                                                break;
                                        }
                                    }
                                    if (inc != 0) {
                                        var selected = input.parentNode.querySelector(".option.selected");
                                        var new_selected = null;
                                        if (!selected) {
                                            var opts = input.parentNode.querySelectorAll(".option");
                                            if (opts) {
                                                if (inc > 0) {
                                                    new_selected = opts[0];
                                                } else {
                                                    new_selected = opts[opts.length - 1];
                                                }
                                            }
                                        } else {
                                            if (inc > 0) {
                                                new_selected = selected.nextElementSibling;
                                            } else {
                                                new_selected = selected.previousElementSibling;
                                            }
                                        }
                                        if (new_selected) {
                                            input.value = new_selected.getAttribute("data-value");
                                            input.dispatchEvent(new Event("change", {bubbles: true}));
                                            adjustSelectedDropdownItem(input.parentNode);
                                        }
                                    }
                                }
                            }
                        });
                        document.querySelectorAll(".dropdown-container .dropdown-content .option").forEach(option_el => {
                            option_el.onclick = function(event) {
                                const opt_el = this;
                                const input = opt_el.parentNode.parentNode.querySelector("input");
                                input.value = option_el.getAttribute("data-value");

                                input.dispatchEvent(new Event("change", {bubbles: true}));
                                opt_el.parentNode.parentNode.classList.remove("dropdown-open");
                                event.stopPropagation();
                            };
                        });
                        window.config = data;
                    } else if (cmd == "READ_EEPROM") {
                        if (data.board_type == "XBOARD") {
                            board_id = "MAIN";
                        } else {
                            board_id = data.common.adapter_id;
                        }
                        updateEepromControls(data.board_type, "COMMON", data.common);
                        updateEepromControls(data.board_type, board_id, data.board);
                        adjustAdapterId();
                    }
                    document.getElementById("movement").value = data["movement"];
                    document.getElementById("frame_ready").checked = data["frame_ready"];
                    document.getElementById("film_detected").checked = data["film_detected"];
                    for (const k2 in data.io) {
						elem = document.getElementById("io."+k2);
						if (elem) {
							elem.checked = data.io[k2];
						}
                    }
                    for (const k2 in data.counters) {
                        document.getElementById("counters."+k2).value = data.counters[k2];
                    }
                    document.getElementById("info").innerHTML = "OK";
                } else {
                    document.getElementById("info").innerHTML = event.data;
                    addLog(event.data);
                }
            };

            window.socket.onclose = function(event) {
                if (event.wasClean && (window.socket.readyState != window.socket.CLOSED)) {
                    try {
                        window.socket.send(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
                    } catch(err) {
                    }
                } else {
                    // e.g. server process killed or network down
                    // event.code is usually 1006 in this case
                    console.log('[close] Connection died');
                    do_disconnect();
                }
            }

            window.socket.onerror = function(error) {
                console.log(`[error]`);
            };
        }
    }

    function disconnect() {
        if (typeof window.socket != "undefined") {
            window.socket.send("BYE");
            window.socket.onclose = function () {};
            window.socket.close();
            do_disconnect();
        }
    }

    function sendCommand(cmd, obj) {
        if (typeof window.socket != "undefined" && window.socket.readyState == window.socket.OPEN) {
            if (typeof obj != "undefined") {
                cmd = cmd + ":" + JSON.stringify(obj);
            }
            //update_status_info("");
            console.log(`[send]: ${cmd}`);
            window.socket.send(cmd);
        }
    }

    function do_disconnect() {
        delete window.socket;
    }


</script>
</html>
